<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>いちご 祖先系統図 | Strawberry Pedigree</title>
  <script src="https://unpkg.com/cytoscape@3.27.0/dist/cytoscape.min.js"></script>
  <script src="https://unpkg.com/dagre@0.8.5/dist/dagre.min.js"></script>
  <script src="https://unpkg.com/cytoscape-dagre@2.5.0/cytoscape-dagre.js"></script>
  <style>
    :root{
      --border:#e5e7eb; --muted:#6b7280; --pink-50:#fff1f7; --pink-100:#FCE7F3;
      --pink-200:#FBCFE8; --pink-300:#F9A8D4; --pink-500:#F472B6; --wine:#831843; --bg:#ffffff;
    }
    body { margin: 0; font-family: system-ui, -apple-system, sans-serif; background: var(--bg); color: #111827; }
    #app { display: grid; grid-template-columns: 320px 1fr 360px; height: 100vh; }
    #left, #right { padding: 12px; overflow: auto; border-right: 1px solid var(--border); }
    #right { border-left: 1px solid var(--border); border-right: none; }
    #cyWrap { position: relative; width: 100%; height: 100%; background: #fafafa; }
    #cy { width: 100%; height: 100%; }
    .h { font-weight: 700; margin: 6px 0 10px; }
    .muted { color: var(--muted); font-size: 12px; line-height: 1.4; }
    .box { border: 1px solid var(--border); border-radius: 10px; padding: 10px; margin: 10px 0; background:#fff; }
    input[type="text"], select { width: 100%; box-sizing: border-box; padding: 10px; border: 1px solid #d1d5db; border-radius: 10px; margin-bottom: 8px; font-size: 14px; }
    #listWrap {
      max-height: 42vh;
      overflow-auto;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: #fff;
      -webkit-overflow-scrolling: touch;
    }
    table { border-collapse: collapse; width: 100%; table-layout: fixed; }
    thead th { position: sticky; top: 0; background: #fff; z-index: 1; font-size: 12px; text-align: left; padding: 8px 10px; border-bottom: 1px solid var(--border); }
    tbody td { font-size: 12px; padding: 8px 10px; border-bottom: 1px solid #f3f4f6; cursor: pointer; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    tbody tr:hover { background: var(--pink-50); }
    .detail-item { margin-bottom: 8px; font-size: 13px; }
    .detail-label { font-weight: bold; color: var(--wine); display: block; margin-bottom: 2px; }
    #loading { position: absolute; inset: 0; display: none; place-items: center; background: rgba(255,255,255,0.8); z-index: 100; }
    #loading.show { display: grid; }
    @media (max-width: 900px) { #app { grid-template-columns: 1fr; height: auto; } #cyWrap { height: 400px; } }
  </style>
</head>
<body>
<div id="app">
  <div id="left">
    <h1 style="font-size:16px; margin:0 0 4px;">祖先のみ表示</h1>
    <p class="muted">選択した品種のルーツを家系図形式で表示します。</p>
    <div class="h">検索</div>
    <input id="q" type="text" placeholder="品種名 / 登録者で検索" />
    <div class="h">さかのぼる世代</div>
    <select id="genLimit">
      <option value="1">1世代前（父母）</option>
      <option value="2">2世代前（祖父母）</option>
      <option value="3" selected>3世代前（曾祖父母）</option>
      <option value="5">5世代前</option>
      <option value="10">可能な限りすべて</option>
    </select>
    <div class="box">
      <div class="h" style="margin-top:0;">品種リスト</div>
      <div id="listWrap">
        <table>
          <thead><tr><th style="width:60%">品種</th><th style="width:40%">登録年</th></tr></thead>
          <tbody id="listBody"><tr><td colspan="2" class="muted">データ読込中...</td></tr></tbody>
        </table>
      </div>
    </div>
  </div>
  <div id="cyWrap">
    <div id="cy"></div>
    <div id="loading"><div class="h">描画中...</div></div>
  </div>
  <div id="right">
    <div class="h">詳細情報</div>
    <div id="detailPanel"><p class="muted">リストから品種を選択してください。</p></div>
  </div>
</div>

<script>
let cy = null;
let rawNodes = [];
let rawEdges = [];
let currentRootId = null;

const cyStyle = [
  { selector: 'node', style: {
    'label': 'data(label)', 'font-size': 12, 'text-valign': 'center', 'text-halign': 'center',
    'background-color': '#fff', 'border-width': 1, 'border-color': '#d1d5db', 'width': 'label', 'padding': '8px',
    'shape': 'round-rectangle', 'text-wrap': 'wrap', 'text-max-width': 80
  }},
  { selector: 'node.root', style: { 'border-width': 3, 'border-color': '#FB7185', 'background-color': '#FFE4E6' }},
  { selector: 'edge', style: {
    'target-arrow-shape': 'triangle', 'curve-style': 'dagre', 'width': 2, 'line-color': '#D1D5DB', 'target-arrow-color': '#D1D5DB',
    'line-style': (e) => (e.data('role') === 'father' ? 'dashed' : 'solid')
  }}
];

async function loadData() {
  const tbody = document.getElementById('listBody');
  try {
    const response = await fetch("elements.json");
    if (!response.ok) throw new Error("ファイルが見つかりません (404)");
    const json = await response.json();

    // ★ 徹底的に要素を探すロジック
    let allItems = [];
    if (Array.isArray(json)) {
      allItems = json;
    } else if (json.elements && Array.isArray(json.elements)) {
      allItems = json.elements;
    } else if (json.nodes && json.edges) {
      // 直列に繋ぐ
      rawNodes = Array.isArray(json.nodes) ? json.nodes : [];
      rawEdges = Array.isArray(json.edges) ? json.edges : [];
    }

    if (allItems.length > 0) {
      // sourceがあればedge、なければnodeとみなす（groupプロパティに頼らない）
      rawNodes = allItems.filter(el => el.data && !el.data.source && !el.data.target);
      rawEdges = allItems.filter(el => el.data && el.data.source && el.data.target);
    }

    // デバッグ用: コンソールに取得結果を表示
    console.log("Nodes found:", rawNodes.length);
    console.log("Edges found:", rawEdges.length);

    if (rawNodes.length === 0) throw new Error("ノードが見つかりません。データの形式を確認してください。");

    renderList();
    document.getElementById('q').addEventListener('input', renderList);
    document.getElementById('genLimit').addEventListener('change', () => {
      if(currentRootId) updateGraph(currentRootId);
    });

  } catch (err) {
    console.error("Load Error:", err);
    tbody.innerHTML = `<tr><td colspan="2" style="color:red; font-size:10px;">エラー: ${err.message}</td></tr>`;
  }
}

function renderList() {
  const q = document.getElementById('q').value.toLowerCase();
  const tbody = document.getElementById('listBody');
  
  const filtered = rawNodes.filter(n => {
    const label = (n.data.label || "").toString().toLowerCase();
    const inst = (n.data.institute || "").toString().toLowerCase();
    // Unknownはリストに出さない
    if (label === "unknown" || label === "不明") return false;
    return label.includes(q) || inst.includes(q);
  });

  if (filtered.length === 0) {
    tbody.innerHTML = '<tr><td colspan="2" class="muted">該当なし</td></tr>';
    return;
  }

  // 読み込みを軽くするため、上位300件程度に制限（必要なら外してください）
  const displayItems = filtered.slice(0, 500);

  tbody.innerHTML = displayItems.map(n => `
    <tr onclick="updateGraph('${n.data.id}')">
      <td>${n.data.label || '---'}</td>
      <td>${n.data.year || '-'}</td>
    </tr>
  `).join('');
}

function updateGraph(rootId) {
  currentRootId = rootId;
  const limit = parseInt(document.getElementById('genLimit').value);
  const loadingEl = document.getElementById('loading');
  loadingEl.classList.add('show');

  // アニメーションのために一瞬待機
  setTimeout(() => {
    const subsetNodes = new Set();
    const subsetEdges = [];
    
    function trace(nodeId, depth) {
      if (depth >= limit) return;
      const parentEdges = rawEdges.filter(e => e.data.target === nodeId);
      parentEdges.forEach(e => {
        subsetNodes.add(e.data.source);
        subsetEdges.push(e);
        trace(e.data.source, depth + 1);
      });
    }
    
    subsetNodes.add(rootId);
    trace(rootId, 0);

    const elements = [
      ...rawNodes.filter(n => subsetNodes.has(n.data.id)),
      ...subsetEdges
    ];

    if (cy) cy.destroy();
    cy = cytoscape({
      container: document.getElementById('cy'),
      elements: elements,
      style: cyStyle,
      layout: { name: 'dagre', rankDir: 'BT', nodeSep: 40, rankSep: 80 },
      userZoomingEnabled: true,
      userPanningEnabled: true
    });

    cy.getElementById(rootId).addClass('root');
    cy.on('tap', 'node', (evt) => showDetail(evt.target.data()));
    
    const rootData = rawNodes.find(n => n.data.id === rootId);
    if (rootData) showDetail(rootData.data);
    loadingEl.classList.remove('show');
  }, 10);
}

function showDetail(d) {
  const panel = document.getElementById('detailPanel');
  
  // 父母を探す
  const findNames = (targetId, role) => rawEdges
    .filter(e => e.data.target === targetId && e.data.role === role)
    .map(e => {
      const p = rawNodes.find(n => n.data.id === e.data.source);
      return p ? p.data.label : '不明';
    }).join(', ');

  // 子を探す
  const children = rawEdges.filter(e => e.data.source === d.id)
    .map(e => {
      const c = rawNodes.find(n => n.data.id === e.data.target);
      return c ? c.data.label : '';
    }).filter(Boolean).join(', ');

  panel.innerHTML = `
    <div class="box">
      <div class="h" style="font-size:16px; color:var(--wine);">${d.label}</div>
      <div class="detail-item"><span class="detail-label">品種登録年</span>${d.year || '-'}</div>
      <div class="detail-item"><span class="detail-label">品種登録者</span>${d.institute || '-'}</div>
      <div class="detail-item"><span class="detail-label">母</span>${findNames(d.id, 'mother') || '-'}</div>
      <div class="detail-item"><span class="detail-label">父</span>${findNames(d.id, 'father') || '-'}</div>
      <div class="detail-item"><span class="detail-label">子</span>${children || '-'}</div>
      <div class="detail-item"><span class="detail-label">交配出典</span>${d.source_id || '-'}</div>
      <div class="detail-item"><span class="detail-label">品種登録情報</span>
        <div class="muted" style="word-break:break-all;">${d.sources ? d.sources.toString().replace(/\n/g, '<br>') : '-'}</div>
      </div>
    </div>
  `;
}

loadData();
</script>
</body>
</html>

