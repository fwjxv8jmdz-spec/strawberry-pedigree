<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>祖先表示 | Strawberry Pedigree</title>
  <meta name="description" content="品種名と世代を指定して、その品種の祖先だけを表示します。" />

  <script src="https://unpkg.com/cytoscape@3.27.0/dist/cytoscape.min.js"></script>
  <script src="https://unpkg.com/dagre@0.8.5/dist/dagre.min.js"></script>
  <script src="https://unpkg.com/cytoscape-dagre@2.5.0/cytoscape-dagre.js"></script>

  <style>
    :root {
      --border: #e5e7eb;
      --muted: #6b7280;
      --pink-50: #fff1f7;
      --pink-100: #FCE7F3;
      --pink-300: #F9A8D4;
      --wine: #831843;
      --bg: #ffffff;
    }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif;
      background: var(--bg);
      color: #111827;
      display: flex;
      flex-direction: column;
      height: 100dvh;
      overflow: hidden;
    }
    header {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
      padding: 10px 15px;
      border-bottom: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(8px);
      z-index: 10;
    }
    input, select {
      padding: 8px 12px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      background: #fff;
      font-size: 14px;
    }
    button {
      padding: 8px 16px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      background: #fff;
      cursor: pointer;
      font-size: 14px;
      font-weight: 700;
    }
    button:hover { background: #f9fafb; }
    #cy {
      flex: 1;
      width: 100%;
      background-color: #fafafa;
    }
    .pill {
      font-size: 12px;
      padding: 2px 10px;
      border: 1px solid var(--border);
      border-radius: 999px;
      color: var(--muted);
      background: #fff;
    }
    .muted { color: var(--muted); font-size: 12px; }
    a { color: #2563eb; text-decoration: none; }
  </style>
</head>

<body>
<header>
  <div>
    <div style="font-weight:900;">祖先のみ表示</div>
    <div class="muted">品種名と世代を指定</div>
  </div>

  <div style="flex:1;"></div>

  <input id="name" list="cultivars" placeholder="品種名（例：とちおとめ）" style="min-width: 200px;" />
  <datalist id="cultivars"></datalist>

  <select id="depth">
    <option value="1">1（親）</option>
    <option value="2" selected>2（祖父母）</option>
    <option value="3">3（曾祖父母）</option>
    <option value="4">4（高祖父母）</option>
    <option value="5">5代前</option>
    <option value="6">6代前</option>
  </select>

  <label style="display:flex; align-items:center; gap:5px; font-size:13px;">
    <input id="includeUnknown" type="checkbox" /> 不明含む
  </label>

  <button id="run">表示</button>
  <span id="badge" class="pill">読込中...</span>
  <a href="./" class="muted">トップへ</a>
</header>

<div id="cy"></div>

<script>
  // Cytoscape拡張の登録
  if (window.cytoscape && window.cytoscapeDagre) {
    cytoscape.use(cytoscapeDagre);
  }

  let all = null;
  let nodeById = new Map();
  let nodeByLabel = new Map();
  let parentsOf = new Map();
  let cy = null;
  let renderToken = 0;
  let currentLayout = null;

  const UNKNOWN_LABELS = new Set(['unknown', '不明', 'n/a', 'nan']);

  function setBadge(text) {
    const el = document.getElementById('badge');
    if (el) el.textContent = text;
  }

  function getParam(name) {
    return new URL(location.href).searchParams.get(name);
  }

  function setParam(name, value) {
    const u = new URL(location.href);
    if (!value) u.searchParams.delete(name);
    else u.searchParams.set(name, value);
    history.replaceState({}, '', u.toString());
  }

  function parseElements(elements) {
    nodeById.clear();
    nodeByLabel.clear();
    parentsOf.clear();

    const nodes = elements.filter(e => e.data?.id && e.data?.label && !e.data?.source);
    const edges = elements.filter(e => e.data?.source && e.data?.target);

    nodes.forEach(n => {
      const id = String(n.data.id).trim();
      nodeById.set(id, n);
      const label = String(n.data.label).trim();
      if (!nodeByLabel.has(label)) nodeByLabel.set(label, id);
    });

    edges.forEach(e => {
      const target = String(e.data.target).trim();
      if (!parentsOf.has(target)) parentsOf.set(target, []);
      parentsOf.get(target).push({
        parentId: String(e.data.source).trim(),
        role: e.data.role || '',
        edgeId: e.data.id
      });
    });

    const dl = document.getElementById('cultivars');
    const sortedLabels = Array.from(nodeByLabel.keys()).sort((a, b) => a.localeCompare(b, 'ja'));
    dl.innerHTML = sortedLabels.map(l => `<option value="${l}">`).join('');
  }

  function collectAncestors(startId, depthN, includeUnknown) {
    const keepNodes = new Set([startId]);
    const resultElements = [];
    let frontier = [startId];

    for (let gen = 1; gen <= depthN; gen++) {
      let nextFrontier = [];
      frontier.forEach(childId => {
        const parents = parentsOf.get(childId) || [];
        parents.forEach(p => {
          const parentNode = nodeById.get(p.parentId);
          if (!parentNode) return;

          const label = String(parentNode.data.label).toLowerCase();
          if (!includeUnknown && UNKNOWN_LABELS.has(label)) return;

          keepNodes.add(p.parentId);
          nextFrontier.push(p.parentId);
          
          resultElements.push({
            data: { id: `e-${p.parentId}-${childId}`, source: p.parentId, target: childId, role: p.role }
          });
        });
      });
      frontier = nextFrontier;
      if (frontier.length === 0) break;
    }

    keepNodes.forEach(id => {
      const n = nodeById.get(id);
      if (n) resultElements.push(n);
    });

    return resultElements;
  }

  function initCy() {
    if (cy) return;
    cy = cytoscape({
      container: document.getElementById('cy'),
      style: [
        {
          selector: 'node',
          style: {
            'label': 'data(label)',
            'font-size': 12,
            'text-valign': 'center',
            'text-halign': 'center',
            'background-color': '#FCE7F3',
            'border-width': 1,
            'border-color': '#F9A8D4',
            'width': 'label',
            'height': 'label',
            'padding': '10px',
            'shape': 'round-rectangle',
            'color': '#831843'
          }
        },
{
          selector: 'edge',
          style: {
            // 'curve-style': 'taxi', を以下に変更
            'curve-style': 'unbundled-bezier',
            'target-arrow-shape': 'triangle',

            'width': 2,
            'arrow-scale': 1.2,
            'edge-distances': 'node-position' // 距離計算の基準
          }
        },
        // 母方のライン：上側に膨らませる
        { 
          selector: 'edge[role="mother"]', 
          style: { 
            'line-color': '#D1B0C2',
            'target-arrow-color': '#D1B0C2',
            'line-style': 'solid', 
            'control-point-distance': -30, 
            'control-point-weight': 0.5 
          } 
        },
        // 父方のライン：下側に膨らませる
        { 
          selector: 'edge[role="father"]', 
          style: { 
            'line-color': '#B0C1D1',
            'target-arrow-color': '#B0C1D1',
            'line-style': 'solid', 
            'control-point-distance': 30, 
            'control-point-weight': 0.5 
          } 
        },
        // 不明のライン：少しだけ膨らませる
        { 
          selector: 'edge[role="unknown"]', 
          style: { 
            'line-style': 'dotted', 
            'line-color': '#cccccc',
            'target-arrow-color': '#cccccc',
            'control-point-distance': 15, 
            'control-point-weight': 0.5 
          } 
        }
      ]
    });
  }

  function run() {
    if (!all) return;
    const myToken = ++renderToken;
    const label = document.getElementById('name').value.trim();
    const depth = parseInt(document.getElementById('depth').value, 10);
    const includeUnknown = document.getElementById('includeUnknown').checked;

    const startId = nodeByLabel.get(label);
    if (!startId) {
      setBadge('未発見');
      return;
    }

    setParam('name', label);
    setParam('n', depth);
    setParam('u', includeUnknown ? '1' : '0');

    const elements = collectAncestors(startId, depth, includeUnknown);
    setBadge('描画中...');

    if (currentLayout) currentLayout.stop();
    
    cy.batch(() => {
      cy.elements().remove();
      cy.add(elements);
    });

    // 描画の安定化のためsetTimeoutを使用
    setTimeout(() => {
      if (myToken !== renderToken) return;
      cy.resize();
      
      currentLayout = cy.layout({
        name: 'dagre',
        rankDir: 'LR',
        ranker: 'longest-path',
        nodeSep: 30,
        rankSep: 100,
        padding: 50,
        animate: true,
        animationDuration: 400,
        fit: true,
        stop: () => {
          if (myToken === renderToken) {
            setBadge(`表示中: ${label} (ノード:${cy.nodes().size()})`);
          }
        }
      });
      currentLayout.run();
    }, 10);
  }

  async function load() {
    try {
      const res = await fetch("/strawberry-pedigree/elements.json?ts=" + Date.now());
      all = await res.json();
      parseElements(all);
      initCy();

      const pName = getParam('name');
      if (pName) {
        document.getElementById('name').value = pName;
        document.getElementById('depth').value = getParam('n') || '2';
        document.getElementById('includeUnknown').checked = getParam('u') === '1';
        run();
      } else {
        setBadge('準備完了');
      }
    } catch (e) {
      setBadge('読込失敗');
    }
  }

  window.addEventListener('DOMContentLoaded', () => {
    document.getElementById('run').addEventListener('click', run);
    document.getElementById('name').addEventListener('keydown', e => { if (e.key === 'Enter') run(); });
    
    // プルダウン変更時の自動更新（少し余裕を持たせる）
    let timer;
    const autoRun = () => {
      clearTimeout(timer);
      timer = setTimeout(run, 150);
    };
    document.getElementById('depth').addEventListener('change', autoRun);
    document.getElementById('includeUnknown').addEventListener('change', autoRun);

    load();
  });

  window.addEventListener('resize', () => {
    if (cy) {
      cy.resize();
      cy.fit(undefined, 50);
    }
  });
</script>
</body>
</html>





