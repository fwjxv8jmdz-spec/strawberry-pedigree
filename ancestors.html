<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>いちご 祖先系統図 | Strawberry Pedigree</title>
  <script src="https://unpkg.com/cytoscape@3.27.0/dist/cytoscape.min.js"></script>
  <script src="https://unpkg.com/dagre@0.8.5/dist/dagre.min.js"></script>
  <script src="https://unpkg.com/cytoscape-dagre@2.5.0/cytoscape-dagre.js"></script>
  <style>
    :root{
      --border:#e5e7eb;
      --muted:#6b7280;
      --pink-50:#fff1f7;
      --pink-100:#FCE7F3;
      --pink-200:#FBCFE8;
      --pink-300:#F9A8D4;
      --pink-400:#FB7185;
      --pink-500:#F472B6;
      --wine:#831843;
      --bg:#ffffff;
    }
    body { margin: 0; font-family: system-ui, -apple-system, sans-serif; background: var(--bg); color: #111827; }
    #app { display: grid; grid-template-columns: 320px 1fr 360px; height: 100vh; }
    #left, #right { padding: 12px; overflow: auto; border-right: 1px solid var(--border); }
    #left { border-right: 1px solid var(--border); }
    #right { border-left: 1px solid var(--border); border-right: none; }
    #cyWrap { position: relative; width: 100%; height: 100%; background: #fafafa; }
    #cy { width: 100%; height: 100%; }
    
    .h { font-weight: 700; margin: 6px 0 10px; }
    .muted { color: var(--muted); font-size: 12px; line-height: 1.4; }
    .box { border: 1px solid var(--border); border-radius: 10px; padding: 10px; margin: 10px 0; background:#fff; }
    
    input[type="text"], select {
      width: 100%; box-sizing: border-box; padding: 10px;
      border: 1px solid #d1d5db; border-radius: 10px; background: #fff; margin-bottom: 8px;
    }

    /* List table */
    #listWrap { max-height: 40vh; overflow: auto; border: 1px solid var(--border); border-radius: 10px; background: #fff; }
    table { border-collapse: collapse; width: 100%; }
    thead th { position: sticky; top: 0; background: #fff; z-index: 1; font-size: 12px; text-align: left; padding: 8px 10px; border-bottom: 1px solid var(--border); }
    tbody td { font-size: 12px; padding: 8px 10px; border-bottom: 1px solid #f3f4f6; cursor: pointer; }
    tbody tr:hover { background: var(--pink-50); }

    /* Detail styles */
    .detail-item { margin-bottom: 8px; font-size: 13px; }
    .detail-label { font-weight: bold; color: var(--wine); display: block; margin-bottom: 2px; }

    #loading {
      position: absolute; inset: 0; display: none; place-items: center;
      background: rgba(255,255,255,0.8); z-index: 100;
    }
    #loading.show { display: grid; }

    @media (max-width: 900px) {
      #app { grid-template-columns: 1fr; height: auto; }
      #left, #right { height: auto; border: none; }
      #cyWrap { height: 500px; }
    }
  </style>
</head>
<body>

<div id="app">
  <div id="left">
    <h1 style="font-size:16px; margin:0 0 4px;">祖先のみ表示</h1>
    <div class="muted" style="margin-bottom:12px;">選択した品種のルーツを家系図形式で表示します。</div>

    <div class="h">検索</div>
    <input id="q" type="text" placeholder="品種名 / 登録者で検索" />

    <div class="h">さかのぼる世代</div>
    <select id="genLimit">
      <option value="1">1世代前（父母）</option>
      <option value="2">2世代前（祖父母）</option>
      <option value="3" selected>3世代前（曾祖父母）</option>
      <option value="4">4世代前</option>
      <option value="5">5世代前</option>
      <option value="10">可能な限りすべて</option>
    </select>

    <div class="box">
      <div class="h" style="margin-top:0;">品種リスト</div>
      <div id="listWrap">
        <table>
          <thead>
            <tr><th>品種</th><th>登録年</th></tr>
          </thead>
          <tbody id="cultivarTableBody">
            <tr><td colspan="2" class="muted">読み込み中...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="cyWrap">
    <div id="cy"></div>
    <div id="loading"><div class="h">描画中...</div></div>
  </div>

  <div id="right">
    <div class="h">詳細情報</div>
    <div id="detailPanel">
      <div class="muted">リストから品種を選択してください。</div>
    </div>
  </div>
</div>

<script>
let cy = null;
let allElements = [];
let currentRootId = null;

// Cytoscape Style
const cyStyle = [
  {
    selector: 'node',
    style: {
      'label': 'data(label)',
      'font-size': 12,
      'text-valign': 'center',
      'text-halign': 'center',
      'background-color': '#FCE7F3',
      'border-width': 1,
      'border-color': '#FBCFE8',
      'color': '#831843',
      'width': 'label',
      'padding': '10px',
      'shape': 'round-rectangle',
      'text-wrap': 'wrap',
      'text-max-width': 120
    }
  },
  {
    selector: 'node.root',
    style: { 'border-width': 3, 'border-color': '#FB7185', 'background-color': '#FFE4E6' }
  },
  {
    selector: 'edge',
    style: {
      'target-arrow-shape': 'triangle',
      'curve-style': 'dagre',
      'width': 2,
      'line-color': '#D1D5DB',
      'target-arrow-color': '#D1D5DB',
      'line-style': (e) => e.data('role') === 'father' ? 'dashed' : 'solid'
    }
  }
];

async function init() {
  try {
    const res = await fetch("elements.json");
    allElements = await res.json();
    renderList();
    
    document.getElementById('q').addEventListener('input', renderList);
    document.getElementById('genLimit').addEventListener('change', () => {
      if(currentRootId) updateGraph(currentRootId);
    });
  } catch (e) {
    console.error("データの読み込みに失敗しました", e);
  }
}

function renderList() {
  const q = document.getElementById('q').value.toLowerCase();
  const tbody = document.getElementById('cultivarTableBody');
  
  // フィルタリング（Unknownは除外）
  const nodes = allElements.nodes.filter(n => {
    const label = (n.data.label || "").toLowerCase();
    const inst = (n.data.institute || "").toLowerCase();
    const isUnknown = label === "unknown" || label === "不明";
    return !isUnknown && (label.includes(q) || inst.includes(q));
  });

  tbody.innerHTML = nodes.map(n => `
    <tr onclick="updateGraph('${n.data.id}')">
      <td>${n.data.label}</td>
      <td class="muted">${n.data.year || '-'}</td>
    </tr>
  `).join('');
}

function updateGraph(rootId) {
  currentRootId = rootId;
  const limit = parseInt(document.getElementById('genLimit').value);
  document.getElementById('loading').classList.add('show');

  // 祖先を辿ってサブセットを作成
  const subsetNodes = new Set();
  const subsetEdges = new Set();
  
  function trace(nodeId, depth) {
    if (depth > limit) return;
    subsetNodes.add(nodeId);
    
    const parentEdges = allElements.edges.filter(e => e.data.target === nodeId);
    parentEdges.forEach(e => {
      subsetEdges.add(e);
      trace(e.data.source, depth + 1);
    });
  }
  
  trace(rootId, 1);

  const elements = {
    nodes: allElements.nodes.filter(n => subsetNodes.has(n.data.id)),
    edges: Array.from(subsetEdges)
  };

  if (cy) cy.destroy();
  
  cy = cytoscape({
    container: document.getElementById('cy'),
    elements: elements,
    style: cyStyle,
    layout: { name: 'dagre', rankDir: 'BT', nodeSep: 50, rankSep: 100 }
  });

  cy.getElementById(rootId).addClass('root');
  
  cy.on('tap', 'node', (evt) => showDetail(evt.target.data()));
  showDetail(allElements.nodes.find(n => n.data.id === rootId).data);
  
  document.getElementById('loading').classList.remove('show');
}

function showDetail(d) {
  const panel = document.getElementById('detailPanel');
  
  // 父母子情報の抽出
  const mothers = allElements.edges.filter(e => e.data.target === d.id && e.data.role === 'mother')
                  .map(e => getNameById(e.data.source)).join(', ') || '-';
  const fathers = allElements.edges.filter(e => e.data.target === d.id && e.data.role === 'father')
                  .map(e => getNameById(e.data.source)).join(', ') || '-';
  const children = allElements.edges.filter(e => e.data.source === d.id)
                  .map(e => getNameById(e.data.target)).join(', ') || '-';

  panel.innerHTML = `
    <div class="box">
      <div class="h" style="font-size:16px; color:var(--wine);">${d.label}</div>
      <div class="detail-item"><span class="detail-label">品種登録年</span>${d.year || '-'}</div>
      <div class="detail-item"><span class="detail-label">品種登録者</span>${d.institute || '-'}</div>
      <div class="detail-item"><span class="detail-label">母</span>${mothers}</div>
      <div class="detail-item"><span class="detail-label">父</span>${fathers}</div>
      <div class="detail-item"><span class="detail-label">子</span>${children}</div>
      <div class="detail-item"><span class="detail-label">交配出典</span>${d.source_id || '-'}</div>
      <div class="detail-item"><span class="detail-label">品種登録情報</span>
        <div class="muted">${d.sources ? d.sources.replace(/\n/g, '<br>') : '-'}</div>
      </div>
    </div>
  `;
}

function getNameById(id) {
  const n = allElements.nodes.find(n => n.data.id === id);
  return n ? n.data.label : id;
}

init();
</script>
</body>
</html>
