<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Strawberry Pedigree</title>

  <!-- Cytoscape core -->
  <script src="https://unpkg.com/cytoscape@3.27.0/dist/cytoscape.min.js"></script>

  <!-- dagre -->
  <script src="https://unpkg.com/dagre@0.8.5/dist/dagre.min.js"></script>
  <script src="https://unpkg.com/cytoscape-dagre@2.5.0/cytoscape-dagre.js"></script>

  <style>
    body { margin: 0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif; }
    #app { display: grid; grid-template-columns: 320px 1fr 360px; height: 100vh; }
    #left, #right { padding: 12px; border-right: 1px solid #e5e7eb; overflow: auto; }
    #right { border-right: none; border-left: 1px solid #e5e7eb; }
    #cy { width: 100%; height: 100%; }

    .h { font-weight: 700; margin: 6px 0 10px; }
    .muted { color: #6b7280; font-size: 12px; line-height: 1.4; }
    .box { border: 1px solid #e5e7eb; border-radius: 10px; padding: 10px; margin: 10px 0; }

    input[type="text"], select {
      width: 100%;
      box-sizing: border-box;
      padding: 10px;
      border: 1px solid #d1d5db;
      border-radius: 10px;
      background: #fff;
    }

    button {
      padding: 8px 10px;
      border: 1px solid #d1d5db;
      background: #fff;
      border-radius: 10px;
      cursor: pointer;
    }
    button:hover { background: #f9fafb; }

    .row { display: flex; gap: 8px; }
    .row > * { flex: 1; }

    .tag {
      display:inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      font-size: 12px;
      margin-right: 6px;
      background: #fff;
    }

    a { color: #2563eb; text-decoration: none; }
    a:hover { text-decoration: underline; }

    /* ===== cultivar list ===== */
    .listHeader {
      display:flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 8px;
      margin: 0 0 8px;
    }
    .pill {
      display:inline-block;
      font-size: 11px;
      padding: 2px 8px;
      border: 1px solid #e5e7eb;
      border-radius: 999px;
      background: #fff;
      color: #6b7280;
      white-space: nowrap;
    }
    #listWrap {
      max-height: 42vh;
      overflow: auto;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      background: #fff;
    }
    table { border-collapse: collapse; width: 100%; }
    thead th {
      position: sticky;
      top: 0;
      background: #fff;
      z-index: 1;
      font-size: 12px;
      text-align: left;
      padding: 8px 10px;
      border-bottom: 1px solid #e5e7eb;
      color: #374151;
    }
    tbody td {
      font-size: 12px;
      padding: 8px 10px;
      border-bottom: 1px solid #f3f4f6;
      vertical-align: top;
      color: #111827;
    }
    tbody tr { cursor: pointer; }
    tbody tr:hover { background: #fff1f7; }
    .td-muted { color: #6b7280; }
    .emptyRow { padding: 12px 10px; font-size: 12px; color: #6b7280; }

    /* filter segmented buttons */
    .seg {
      display:flex;
      gap: 6px;
      margin: 8px 0 8px;
    }
    .seg button{
      flex: 1;
      font-size: 12px;
      padding: 8px 8px;
      border-radius: 999px;
    }
    .seg button.active{
      border-color: #F9A8D4;
      background: #FCE7F3;
      color: #831843;
      font-weight: 600;
    }

    /* layout two buttons */
    .layoutBtns { display:flex; gap: 8px; margin-top: 6px; }
    .layoutBtns button.active{
      border-color: #F9A8D4;
      background: #FCE7F3;
      color: #831843;
      font-weight: 700;
    }
  </style>
</head>

<body>
<div id="app">
  <div id="left">
    <div class="h">検索</div>
    <input id="q" type="text" placeholder="品種名 / 登録者で検索（例：とちおとめ、栃木県）" />

    <div class="box">
      <div class="listHeader">
        <div class="h" style="margin:0;">品種リスト</div>
        <span id="listBadge" class="pill">準備中…</span>
      </div>

      <div class="muted" style="margin:0 0 6px;">
        行をクリックするとその品種へ移動します。
      </div>

      <div class="seg" role="tablist" aria-label="品種リスト フィルタ">
        <button id="f_all" class="active" type="button">全品種</button>
        <button id="f_reg" type="button">登録品種</button>
        <button id="f_orphan" type="button">親が不明</button>
      </div>

      <div id="listWrap">
        <div class="emptyRow">elements.json 読み込み中…</div>
      </div>

      <div class="muted" style="margin-top:8px;">
        全品種: 本系統図に含まれるすべての品種; 登録品種: 農林水産省による登録を受けた品種; 親が不明: 情報を募集しています。
      </div>
    </div>


  </div>

  <div id="cy"></div>

  <div id="right">
        <div class="box">
      <div class="h" style="margin:0 0 6px;">利用条件・免責</div>
      <div class="muted">
        本サイトのデータの利用条件は以下をご確認ください。
        <ul style="padding-left:16px; margin:6px 0;">
          <li>
            <a href="https://github.com/fwjxv8jmdz-spec/strawberry-pedigree/blob/main/LICENSE"
               target="_blank" rel="noopener noreferrer">
              ソースコード：MIT License
            </a>
          </li>
          <li>
            <a href="https://github.com/fwjxv8jmdz-spec/strawberry-pedigree/blob/main/DATA_LICENSE.md"
               target="_blank" rel="noopener noreferrer">
              データ：CC BY-NC 4.0
            </a>
          </li>
        </ul>
        <div style="margin-top:6px;">
          本データは研究・教育・参考目的で提供されており, 十分に注意して作成しましたが，内容の正確性や完全性を保証するものではありません。
        </div>
      </div>
        <div class="box">
      <div class="h" style="margin:0 0 6px;">レイアウト</div>
      <div class="layoutBtns">
        <button id="btnCose" class="active" type="button">CoSE</button>
        <button id="btnDagre" type="button">Dagre</button>
      </div>
      <div class="muted" style="margin-top:6px;">
        ボタンでレイアウトを即時適用します。
      </div>
    </div>

    <div class="box">
      <div class="h" style="margin:0 0 6px;">凡例</div>
      <div><span class="tag">母 → 子</span> 実線</div>
      <div><span class="tag">父 → 子</span> 破線</div>
      <div class="muted" style="margin-top:6px;">品種名をドラッグして配置変更・ホイールで拡大縮小できます。</div>
    </div>
    
    <div class="h">詳細</div>
    <div id="detail" class="muted">品種名をクリックすると情報が表示されます。</div>


  </div>

  </div>
</div>

<script>
let cy = null;

/* ===== list state ===== */
let listFilter = 'all'; // 'all' | 'reg' | 'orphan'

function esc(s){
  return (s ?? '').toString()
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;');
}

function uniq(arr){
  const seen = new Set();
  const out = [];
  for(const v of arr){
    const s = (v ?? '').toString().trim();
    if(!s) continue;
    if(seen.has(s)) continue;
    seen.add(s);
    out.push(s);
  }
  return out;
}

/* 「不明」ノードをリストから除外：label が unknown / 不明（大文字小文字無視） */
function isUnknownNode(n){
  const label = ((n.data('label') ?? '') + '').trim().toLowerCase();
  return (label === 'unknown' || label === '不明');
}

function isRegisteredNode(n){
  const y = n.data('year');
  return (y !== undefined && y !== null && ('' + y).trim() !== '');
}

/*
  親が不明（定義）：
  - mother または father の親名（source側ノードlabel）が unknown / 不明
*/
function hasUnknownParentByRole(n){
  const incomers = n.incomers('edge');
  const mfEdges = incomers.filter(e => {
    const r = e.data('role');
    return r === 'mother' || r === 'father';
  });
  const parents = mfEdges.sources();
  for(const p of parents){
    const pl = ((p.data('label') ?? '') + '').trim().toLowerCase();
    if(pl === 'unknown' || pl === '不明') return true;
  }
  return false;
}

/* ===== Sorting helpers =====
   - 全品種/親が不明: 日本語(50音) → アルファベット → 数字
   - 登録品種: 年(降順) → 同年/年なしは上と同じ
*/
const collJa = new Intl.Collator('ja', { numeric: true, sensitivity: 'base' });
const collEn = new Intl.Collator('en', { numeric: true, sensitivity: 'base' });

// 0:日本語, 1:英字, 2:数字, 3:その他（最後）
function labelGroup(label){
  const s = (label ?? '').toString().trim();
  if(!s) return 3;
  const ch = s[0];

  // 数字
  if(/[0-9]/.test(ch)) return 2;

  // 英字
  if(/[A-Za-z]/.test(ch)) return 1;

  // 日本語（ひらがな・カタカナ・漢字あたりをざっくり包含）
  if(/[\u3040-\u30FF\u3400-\u9FFF]/.test(ch)) return 0;

  return 3;
}

function compareLabelJPENNUM(a, b){
  const la = (a.data('label') ?? '').toString();
  const lb = (b.data('label') ?? '').toString();

  const ga = labelGroup(la);
  const gb = labelGroup(lb);
  if(ga !== gb) return ga - gb; // ★ 日本語→英字→数字→その他

  // 同じグループ内の比較
  if(ga === 1) return collEn.compare(la, lb); // 英字
  return collJa.compare(la, lb);              // 日本語・数字・その他は ja の自然順
}

function parseYear(n){
  const y = (n.data('year') ?? '').toString().trim();
  const num = parseInt(y, 10);
  return Number.isFinite(num) ? num : null;
}

function setDetail(n){
  if(!n){
    document.getElementById('detail').innerHTML =
      '<span class="muted">ノードをクリックすると情報が表示されます。</span>';
    return;
  }

  const d = n.data();

  const year = d.year ? `<div><b>品種登録年</b>：${esc(d.year)}</div>` : '';
  const inst = d.institute ? `<div><b>品種登録者</b>：${esc(d.institute)}</div>` : '';
  const notes = d.notes ? `<div style="margin-top:8px;"><b>メモ</b><div>${esc(d.notes)}</div></div>` : '';

  let sourcesHtml = '';
  if(d.sources){
    const parts = d.sources.toString().split(/[\n;]+/).map(x => x.trim()).filter(Boolean);
    const links = parts.map(p => {
      const isUrl = /^https?:\/\//i.test(p);
      return isUrl
        ? `<div><a href="${esc(p)}" target="_blank" rel="noopener noreferrer">${esc(p)}</a></div>`
        : `<div>${esc(p)}</div>`;
    }).join('');
    sourcesHtml = `<div style="margin-top:8px;"><b>品種登録情報</b>${links}</div>`;
  }

  const incomers = n.incomers('edge');
  const mothers = incomers.filter(e => e.data('role') === 'mother').sources().map(x => x.data('label'));
  const fathers = incomers.filter(e => e.data('role') === 'father').sources().map(x => x.data('label'));
  const unknowns = incomers.filter(e => e.data('role') === 'unknown').sources().map(x => x.data('label'));

  const outgoers = n.outgoers('edge');
  const children = outgoers.targets().map(x => x.data('label'));

  const motherHtml = mothers.length ? `<div><b>母</b>：${uniq(mothers).map(esc).join(', ')}</div>` : '';
  const fatherHtml = fathers.length ? `<div><b>父</b>：${uniq(fathers).map(esc).join(', ')}</div>` : '';
  const unknownHtml = unknowns.length ? `<div><b>不明親</b>：${uniq(unknowns).map(esc).join(', ')}</div>` : '';
  const childHtml = children.length ? `<div style="margin-top:8px;"><b>子</b><div>${uniq(children).map(esc).join(', ')}</div></div>` : '';

  const crossSources = uniq(incomers.map(e => e.data('source_id')));
  const crossSourcesHtml = crossSources.length
    ? `<div style="margin-top:8px;"><b>交配出典</b><div>${crossSources.map(esc).join('<br>')}</div></div>`
    : '';

  const ph = (d.placeholder === true) ? `<div class="muted" style="margin-top:6px;">※この品種情報は未登録です。</div>` : '';

  document.getElementById('detail').innerHTML = `
    <div class="box">
      <div class="h" style="margin:0 0 6px;">${esc(d.label)}</div>
      ${year}
      ${inst}
      ${motherHtml}
      ${fatherHtml}
      ${unknownHtml}
      ${childHtml}
      ${notes}
      ${crossSourcesHtml}
      ${sourcesHtml}
      ${ph}
    </div>
  `;
}

function setActiveLayout(btnId){
  document.getElementById('btnCose').classList.toggle('active', btnId === 'btnCose');
  document.getElementById('btnDagre').classList.toggle('active', btnId === 'btnDagre');
}

function runLayout(mode){
  if(!cy) return;
  cy.stop();

  const padding = 30;
  let opts;

  if(mode === 'dagre'){
    opts = {
      name: 'dagre',
      rankDir: 'LR',
      nodeSep: 20,
      edgeSep: 5,
      rankSep: 90,
      padding,
      nodeDimensionsIncludeLabels: true,
      animate: true
    };
  }else{
    // COSE
    opts = {
      name: 'cose',
      padding: 30,
      animate: true,
      randomize: true,
      avoidOverlap: true,
      avoidOverlapPadding: 20,
      nodeOverlap: 40,
      nodeRepulsion: 6500,
      idealEdgeLength: 140,
      componentSpacing: 80,
      numIter: 1200
    };
  }

  cy.layout(opts).run();
  cy.fit(undefined, 30);
}

/* ===== selection helper ===== */
function selectNode(n, doFit=true){
  if(!n) return;

  setDetail(n);

  cy.elements().removeClass('faded');
  cy.elements().removeClass('highlight');

  const neighborhood = n.closedNeighborhood();
  cy.elements().not(neighborhood).addClass('faded');
  n.addClass('highlight');

  if(doFit){
    cy.animate({ fit: { eles: neighborhood, padding: 80 } }, { duration: 250 });
  }
}

/* ===== list rendering ===== */
function applyListFilter(nodes){
  if(listFilter === 'reg'){
    return nodes.filter(n => isRegisteredNode(n) && n.data('placeholder') !== true);
  }
  if(listFilter === 'orphan'){
    return nodes.filter(n => hasUnknownParentByRole(n));
  }
  return nodes;
}

function filterLabel(){
  if(listFilter === 'reg') return '登録品種';
  if(listFilter === 'orphan') return '親が不明';
  return '全品種';
}

function renderCultivarList(nodes, badgeText){
  const wrap = document.getElementById('listWrap');
  const badge = document.getElementById('listBadge');

  badge.textContent = badgeText;

  if(!nodes.length){
    wrap.innerHTML = `<div class="emptyRow">該当する品種がありません。</div>`;
    return;
  }

  const rows = nodes.map(n => {
    const d = n.data();
    const label = esc(d.label ?? '');
    const year = esc(d.year ?? '');
    const inst = esc(d.institute ?? '');
    const id = esc(d.id ?? n.id());
    return `
      <tr data-node-id="${id}">
        <td>${label || '<span class="td-muted">（無名）</span>'}</td>
        <td class="td-muted" style="white-space:nowrap;">${year || '-'}</td>
        <td class="td-muted">${inst || '-'}</td>
      </tr>
    `;
  }).join('');

  wrap.innerHTML = `
    <table>
      <thead>
        <tr>
          <th style="width:35%;">品種</th>
          <th style="width:18%;">年</th>
          <th>登録者</th>
        </tr>
      </thead>
      <tbody>${rows}</tbody>
    </table>
  `;

  wrap.querySelectorAll('tbody tr').forEach(tr => {
    tr.addEventListener('click', () => {
      const nodeId = tr.getAttribute('data-node-id');
      const n = cy.getElementById(nodeId);
      if(n && n.length){
        selectNode(n, true);
      }
    });
  });
}

function updateListAndHighlights(){
  if(!cy) return;

  const term = (document.getElementById('q').value ?? '').trim().toLowerCase();

  // リスト候補：unknown / 不明 ノードは除外
  let base = cy.nodes().filter(n => !isUnknownNode(n));

  // フィルタ適用
  let nodes = applyListFilter(base);

  // 検索があればさらに絞る
  if(term){
    nodes = nodes.filter(n => {
      const label = ((n.data('label') || '') + '').toLowerCase();
      const inst  = ((n.data('institute') || '') + '').toLowerCase();
      return label.includes(term) || inst.includes(term);
    });
  }

  // ===== ソート仕様の反映 =====
  const sorted = nodes.toArray().sort((a, b) => {
    // 登録品種：年の降順 → 同年/年なしは 日本語→英字→数字
    if(listFilter === 'reg'){
      const ya = parseYear(a);
      const yb = parseYear(b);

      const va = (ya !== null);
      const vb = (yb !== null);

      if(va && vb && ya !== yb) return yb - ya; // 降順
      if(va !== vb) return va ? -1 : 1;        // 年あり優先

      return compareLabelJPENNUM(a, b);
    }

    // 全品種 / 親が不明：日本語(50音) → 英字 → 数字
    return compareLabelJPENNUM(a, b);
  });

  const badgeText = term
    ? `検索結果（${filterLabel()}）：${sorted.length}件`
    : `${filterLabel()}：${sorted.length}件`;

  renderCultivarList(sorted, badgeText);

  // グラフ側のハイライトは「検索語がある時だけ」
  cy.nodes().removeClass('highlight');
  if(term){
    const matched = cy.nodes().filter(n => {
      const label = ((n.data('label') || '') + '').toLowerCase();
      const inst  = ((n.data('institute') || '') + '').toLowerCase();
      return label.includes(term) || inst.includes(term);
    });
    matched.addClass('highlight');
    if(matched.length){
      cy.animate({ fit: { eles: matched, padding: 80 } }, { duration: 200 });
    }
  }
}

function setActiveFilter(btnId){
  ['f_all','f_reg','f_orphan'].forEach(id => {
    const el = document.getElementById(id);
    el.classList.toggle('active', id === btnId);
  });
}

function initCy(elements){
  cy = cytoscape({
    container: document.getElementById('cy'),
    elements,
    style: [
      /* ===== nodes ===== */
      {
        selector: 'node',
        style: {
          'label': 'data(label)',
          'font-size': 12,
          'text-wrap': 'wrap',
          'text-max-width': 150,
          'text-valign': 'center',
          'text-halign': 'center',

          'background-color': '#FCE7F3',
          'border-width': 1.5,
          'border-color': '#F9A8D4',
          'color': '#831843',

          'width': 'label',
          'padding': '12px',
          'shape': 'round-rectangle'
        }
      },

      /* 登録品種 */
      {
        selector: 'node.registered',
        style: {
          'border-width': 2.6,
          'border-color': '#ff5fa2',
          'background-color': '#ffd9eb',
          'font-weight': '600',
          'shadow-blur': 10,
          'shadow-color': '#ff9ac6',
          'shadow-opacity': 0.35
        }
      },

      /* 未登録 */
      {
        selector: 'node.isPlaceholder',
        style: {
          'background-color': '#FFF5FB',
          'border-color': '#FBCFE8',
          'color': '#9F1239',
          'shadow-opacity': 0
        }
      },

      /* ===== edges ===== */
      {
        selector: 'edge',
        style: {
          'source-endpoint': 'outside-to-node',
          'target-endpoint': 'outside-to-node',
          'source-distance-from-node': 0,
          'target-distance-from-node': 2,

          'curve-style': 'unbundled-bezier',
          'edge-distances': 'node-position',
          'target-arrow-shape': 'triangle',
          'target-arrow-fill': 'filled',
          'arrow-scale': 1.2,
          'width': 2,
          'line-color': '#F472B6',
          'target-arrow-color': '#F472B6'
        }
      },

      /* mother */
      {
        selector: 'edge[role="mother"]',
        style: {
          'line-style': 'solid',
          'line-color': '#F472B6',
          'target-arrow-color': '#F472B6',
          'control-point-distance': 30,
          'control-point-weight': 0.5
        }
      },

      /* father */
      {
        selector: 'edge[role="father"]',
        style: {
          'line-style': 'dashed',
          'line-color': '#F472B6',
          'target-arrow-color': '#F472B6',
          'control-point-distance': -30,
          'control-point-weight': 0.5
        }
      },

      /* unknown */
      {
        selector: 'edge[role="unknown"]',
        style: {
          'line-style': 'dotted',
          'line-color': '#E5E7EB',
          'target-arrow-color': '#E5E7EB',
          'control-point-distance': 18,
          'control-point-weight': 0.5
        }
      },

      /* ===== interaction ===== */
      { selector: '.faded', style: { 'opacity': 0.2 } },
      { selector: '.highlight', style: { 'border-width': 3, 'border-color': '#FB7185' } }
    ],

    // 初期は COSE
    layout: {
      name: 'cose',
      padding: 30,
      animate: true,
      randomize: true,
      avoidOverlap: true,
      avoidOverlapPadding: 20,
      nodeOverlap: 40,
      nodeRepulsion: 6500,
      idealEdgeLength: 140,
      componentSpacing: 80,
      numIter: 1200
    }
  });

  // データからクラス付与
  cy.batch(() => {
    cy.nodes().forEach(n => {
      const d = n.data();
      if (d.year !== undefined && d.year !== null && d.year !== '') n.addClass('registered');
      if (d.placeholder === true) n.addClass('isPlaceholder');
    });
  });

  // click handlers
  cy.on('tap', 'node', (evt) => {
    selectNode(evt.target, false);
  });

  cy.on('tap', (evt) => {
    if(evt.target === cy){
      cy.elements().removeClass('faded');
      cy.elements().removeClass('highlight');
      setDetail(null);
    }
  });

  // search
  document.getElementById('q').addEventListener('input', () => {
    updateListAndHighlights();
  });

  // filter buttons
  document.getElementById('f_all').addEventListener('click', () => {
    listFilter = 'all';
    setActiveFilter('f_all');
    updateListAndHighlights();
  });

  document.getElementById('f_reg').addEventListener('click', () => {
    listFilter = 'reg';
    setActiveFilter('f_reg');
    updateListAndHighlights();
  });

  document.getElementById('f_orphan').addEventListener('click', () => {
    listFilter = 'orphan';
    setActiveFilter('f_orphan');
    updateListAndHighlights();
  });

  // layout buttons
  document.getElementById('btnCose').addEventListener('click', () => {
    setActiveLayout('btnCose');
    runLayout('cose');
  });

  document.getElementById('btnDagre').addEventListener('click', () => {
    setActiveLayout('btnDagre');
    runLayout('dagre');
  });

  // 初期：全品種一覧（ここで badge も「全品種：XXX件」になる）
  updateListAndHighlights();
  cy.fit(undefined, 30);
}

async function loadElements(){
  const wrap = document.getElementById('listWrap');
  const badge = document.getElementById('listBadge');

  try{
    const url = "elements.json?ts=" + Date.now();
    const res = await fetch(url, { cache: "no-store" });
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const elements = await res.json();

    initCy(elements);

    // ★ ここで「全品種：読込OK」を表示しない（件数表示は initCy→updateListAndHighlights が担当）
    // badge.textContent = '全品種：読込OK';

  }catch(err){
    badge.textContent = '読み込み失敗';
    wrap.innerHTML = `<div class="emptyRow">読み込み失敗：${esc(err.message)}<br>（elements.json が root にあるか確認）</div>`;
  }
}

loadElements();
</script>
<footer style="
  position: fixed;
  bottom: 6px;
  right: 10px;
  font-size: 11px;
  color: #6b7280;
  background: rgba(255,255,255,0.8);
  padding: 2px 6px;
  border-radius: 6px;
  z-index: 10;
">
  © 2025 Takumi Fujiki.
  <a href="https://github.com/fwjxv8jmdz-spec/strawberry-pedigree/blob/main/README.html" target="_blank" rel="noopener noreferrer">README</a>
  <a href="https://github.com/fwjxv8jmdz-spec/strawberry-pedigree/blob/main/LICENSE"
     target="_blank" rel="noopener noreferrer">
    Code: MIT
  </a>
  /
  <a href="https://github.com/fwjxv8jmdz-spec/strawberry-pedigree/blob/main/DATA_LICENSE.md"
     target="_blank" rel="noopener noreferrer">
    Data: CC BY-NC 4.0
  </a>
</footer>
  
</body>
</html>
