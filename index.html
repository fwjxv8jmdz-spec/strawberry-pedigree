<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Strawberry Pedigree Prototype</title>
  <script src="https://unpkg.com/cytoscape@3.27.0/dist/cytoscape.min.js"></script>
  <style>
    body { margin: 0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif; }
    #app { display: grid; grid-template-columns: 320px 1fr 340px; height: 100vh; }
    #left, #right { padding: 12px; border-right: 1px solid #e5e7eb; overflow: auto; }
    #right { border-right: none; border-left: 1px solid #e5e7eb; }
    #cy { width: 100%; height: 100%; }
    .h { font-weight: 700; margin: 6px 0 10px; }
    .muted { color: #6b7280; font-size: 12px; }
    .box { border: 1px solid #e5e7eb; border-radius: 10px; padding: 10px; margin: 10px 0; }
    input[type="text"] { width: 100%; box-sizing: border-box; padding: 10px; border: 1px solid #d1d5db; border-radius: 10px; }
    button { padding: 8px 10px; border: 1px solid #d1d5db; background: #fff; border-radius: 10px; cursor: pointer; }
    button:hover { background: #f9fafb; }
    .row { display: flex; gap: 8px; }
    .row > * { flex: 1; }
    .tag { display:inline-block; padding: 2px 8px; border-radius: 999px; border: 1px solid #e5e7eb; font-size: 12px; margin-right: 6px; }
    a { color: #2563eb; text-decoration: none; }
    a:hover { text-decoration: underline; }
    ul { padding-left: 18px; }
  </style>
</head>
<body>
<div id="app">
  <div id="left">
    <div class="h">検索</div>
    <input id="q" type="text" placeholder="品種名で検索（例：とねほっぺ）" />
    <div class="row" style="margin-top:10px;">
      <button id="fit">全体表示</button>
      <button id="clear">選択解除</button>
    </div>

    <div class="box">
      <div class="h" style="margin:0 0 6px;">凡例</div>
      <div><span class="tag">母 → 子</span> 実線</div>
      <div><span class="tag">父 → 子</span> 破線</div>
      <div class="muted" style="margin-top:6px;">ノードをドラッグして配置変更できます。ホイールで拡大縮小。</div>
    </div>

    <div class="box">
      <div class="h" style="margin:0 0 6px;">操作</div>
      <ul class="muted">
        <li>ノードクリック：右側に詳細</li>
        <li>Shift+クリック：複数選択</li>
        <li>検索：一致ノードをハイライト</li>
      </ul>
    </div>
  </div>

  <div id="cy"></div>

  <div id="right">
    <div class="h">詳細</div>
    <div id="detail" class="muted">ノードをクリックすると情報が表示されます。</div>
  </div>
</div>

<script>
const elements = [{"data": {"id": "佐賀i9号", "label": "佐賀i9号", "year": null, "institute": null, "notes": null, "sources": null, "placeholder": false}}, {"data": {"id": "左系14号", "label": "左系14号", "year": null, "institute": null, "notes": null, "sources": null, "placeholder": true}}, {"data": {"id": "やよいひめ", "label": "やよいひめ", "year": null, "institute": null, "notes": null, "sources": null, "placeholder": false}}, {"data": {"id": "佐系14号", "label": "佐系14号", "year": null, "institute": null, "notes": null, "sources": null, "placeholder": false}}, {"data": {"id": "99-26-7", "label": "99-26-7", "year": null, "institute": null, "notes": null, "sources": null, "placeholder": false}}, {"data": {"id": "99-5-3", "label": "99-5-3", "year": null, "institute": null, "notes": null, "sources": null, "placeholder": false}}, {"data": {"id": "さがほのか", "label": "さがほのか", "year": null, "institute": null, "notes": null, "sources": null, "placeholder": true}}, {"data": {"id": "KA-16", "label": "KA-16", "year": null, "institute": null, "notes": null, "sources": null, "placeholder": true}}, {"data": {"id": "97-9-1", "label": "97-9-1", "year": null, "institute": null, "notes": null, "sources": null, "placeholder": true}}, {"data": {"id": "97-5-8", "label": "97-5-8", "year": null, "institute": null, "notes": null, "sources": null, "placeholder": true}}, {"data": {"id": "96-01-001", "label": "96-01-001", "year": null, "institute": null, "notes": null, "sources": null, "placeholder": false}}, {"data": {"id": "とねほっぺ", "label": "とねほっぺ", "year": null, "institute": null, "notes": null, "sources": null, "placeholder": false}}, {"data": {"id": "とちおとめ", "label": "とちおとめ", "year": null, "institute": null, "notes": null, "sources": null, "placeholder": true}}, {"data": {"id": "系56", "label": "系56", "year": null, "institute": null, "notes": null, "sources": null, "placeholder": true}}, {"data": {"id": "女峰", "label": "女峰", "year": null, "institute": null, "notes": null, "sources": null, "placeholder": true}}, {"data": {"id": "e1", "source": "左系14号", "target": "佐賀i9号", "role": "mother"}}, {"data": {"id": "e2", "source": "やよいひめ", "target": "佐賀i9号", "role": "father"}}, {"data": {"id": "e3", "source": "99-26-7", "target": "佐系14号", "role": "mother"}}, {"data": {"id": "e4", "source": "99-5-3", "target": "佐系14号", "role": "father"}}, {"data": {"id": "e5", "source": "さがほのか", "target": "99-26-7", "role": "mother"}}, {"data": {"id": "e6", "source": "KA-16", "target": "99-26-7", "role": "father"}}, {"data": {"id": "e7", "source": "97-9-1", "target": "99-5-3", "role": "mother"}}, {"data": {"id": "e8", "source": "97-5-8", "target": "99-5-3", "role": "father"}}, {"data": {"id": "e9", "source": "96-01-001", "target": "やよいひめ", "role": "mother"}}, {"data": {"id": "e10", "source": "とねほっぺ", "target": "やよいひめ", "role": "father"}}, {"data": {"id": "e11", "source": "とねほっぺ", "target": "96-01-001", "role": "mother"}}, {"data": {"id": "e12", "source": "とちおとめ", "target": "96-01-001", "role": "father"}}, {"data": {"id": "e13", "source": "系56", "target": "とねほっぺ", "role": "mother"}}, {"data": {"id": "e14", "source": "女峰", "target": "とねほっぺ", "role": "father"}}];

const cy = cytoscape({
  container: document.getElementById('cy'),
  elements,
  style: [
    {
      selector: 'node',
      style: {
        'label': 'data(label)',
        'font-size': 12,
        'text-wrap': 'wrap',
        'text-max-width': 120,
        'text-valign': 'center',
        'text-halign': 'center',
        'background-color': '#111827',
        'color': '#ffffff',
        'width': 'label',
        'height': 'label',
        'padding': '10px',
        'shape': 'round-rectangle'
      }
    },
    {
      selector: 'node[placeholder]',
      style: {
        'background-color': '#6b7280'
      }
    },
    {
      selector: 'edge',
      style: {
        'curve-style': 'bezier',
        'target-arrow-shape': 'triangle',
        'arrow-scale': 1,
        'width': 2,
        'line-color': '#111827',
        'target-arrow-color': '#111827'
      }
    },
    {
      selector: 'edge[role="father"]',
      style: {
        'line-style': 'dashed'
      }
    },
    {
      selector: 'edge[role="unknown"]',
      style: {
        'line-style': 'dotted',
        'line-color': '#9ca3af',
        'target-arrow-color': '#9ca3af'
      }
    },
    {
      selector: '.faded',
      style: {
        'opacity': 0.15
      }
    },
    {
      selector: '.highlight',
      style: {
        'border-width': 3,
        'border-color': '#f59e0b'
      }
    }
  ],
  layout: { name: 'breadthfirst', directed: true, padding: 20, spacingFactor: 1.2 }
});

function esc(s){
  return (s ?? '').toString()
    .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
}

function setDetail(n){
  if(!n){ 
    document.getElementById('detail').innerHTML = '<span class="muted">ノードをクリックすると情報が表示されます。</span>';
    return;
  }
  const d = n.data();
  const year = d.year ? `<div><b>育成年</b>：${esc(d.year)}</div>` : '';
  const inst = d.institute ? `<div><b>育成機関</b>：${esc(d.institute)}</div>` : '';
  const notes = d.notes ? `<div style="margin-top:8px;"><b>メモ</b><div>${esc(d.notes)}</div></div>` : '';
  const sources = d.sources ? `<div style="margin-top:8px;"><b>出典</b><div>${esc(d.sources)}</div></div>` : '';

  // parents/children
  const incomers = n.incomers('edge');
  const mothers = incomers.filter(e => e.data('role') === 'mother').sources().map(x => x.data('label'));
  const fathers = incomers.filter(e => e.data('role') === 'father').sources().map(x => x.data('label'));

  const outgoers = n.outgoers('edge');
  const children = outgoers.targets().map(x => x.data('label'));

  const motherHtml = mothers.length ? `<div><b>母</b>：${mothers.map(esc).join(', ')}</div>` : '';
  const fatherHtml = fathers.length ? `<div><b>父</b>：${fathers.map(esc).join(', ')}</div>` : '';
  const childHtml = children.length ? `<div style="margin-top:8px;"><b>子（この品種を親に持つ）</b><div>${children.map(esc).join(', ')}</div></div>` : '';

  const ph = d.placeholder ? `<div class="muted" style="margin-top:6px;">※このノードは「親として登場したが、品種情報が未入力」です。</div>` : '';

  document.getElementById('detail').innerHTML = `
    <div class="box">
      <div class="h" style="margin:0 0 6px;">${esc(d.label)}</div>
      ${year}
      ${inst}
      ${motherHtml}
      ${fatherHtml}
      ${childHtml}
      ${notes}
      ${sources}
      ${ph}
    </div>
  `;
}

// click handlers
cy.on('tap', 'node', (evt) => {
  const n = evt.target;
  setDetail(n);

  cy.elements().removeClass('faded');
  cy.elements().removeClass('highlight');

  const neighborhood = n.closedNeighborhood();
  cy.elements().not(neighborhood).addClass('faded');
  n.addClass('highlight');
});

cy.on('tap', (evt) => {
  if(evt.target === cy){
    cy.elements().removeClass('faded');
    cy.elements().removeClass('highlight');
    setDetail(null);
  }
});

// search
const q = document.getElementById('q');
q.addEventListener('input', () => {
  const term = q.value.trim();
  cy.nodes().removeClass('highlight');
  if(!term) return;

  const matched = cy.nodes().filter(n => (n.data('label') || '').includes(term));
  matched.addClass('highlight');
  if(matched.length){
    cy.animate({ fit: { eles: matched, padding: 80 } }, { duration: 200 });
  }
});

document.getElementById('fit').addEventListener('click', () => cy.fit(undefined, 30));
document.getElementById('clear').addEventListener('click', () => {
  q.value = '';
  cy.elements().removeClass('faded');
  cy.elements().removeClass('highlight');
  setDetail(null);
});
</script>
</body>
</html>
