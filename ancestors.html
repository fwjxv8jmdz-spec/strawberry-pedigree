<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  
  <title>いちご 品種系統図（祖先表示） | Strawberry Pedigree</title>
  <meta name="description" content="日本のいちご品種が中心の品種系統図です。品種名と世代を指定して、その品種の祖先だけを抽出して表示します。" />

  <link rel="icon" href="icon.svg" type="image/svg+xml">
  <link rel="icon" href="icon32.png" sizes="32x32" type="image/png">
  <link rel="icon" href="icon16.png" sizes="16x16" type="image/png">
  
  <script src="https://unpkg.com/cytoscape@3.27.0/dist/cytoscape.min.js"></script>
  <script src="https://unpkg.com/dagre@0.8.5/dist/dagre.min.js"></script>
  <script src="https://unpkg.com/cytoscape-dagre@2.5.0/cytoscape-dagre.js"></script>

  <style>
    :root {
      --border: #e5e7eb;
      --muted: #6b7280;
      --pink-50: #fff1f7;
      --pink-100: #FCE7F3;
      --pink-300: #F9A8D4;
      --wine: #831843;
      --bg: #ffffff;
    }

    html, body { 
      height: 100%; 
      margin: 0; 
      padding: 0;
      overflow: hidden; 
    }
    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: #111827;
    }
    a { color: #2563eb; text-decoration: none; }

    /* ===== Layout ===== */
    #app {
      display: grid;
      grid-template-columns: 320px 1fr 320px;
      height: 100vh;
      width: 100vw;
    }

    #left, #right {
      overflow-y: auto;
      padding: 16px;
      background: #fff;
      z-index: 10;
    }
    #left { border-right: 1px solid var(--border); }
    #right { border-left: 1px solid var(--border); }

    #cyWrap {
      position: relative;
      flex: 1;
      height: 100%;
      background: #fafafa;
      overflow: hidden;
    }
    #cy { width: 100%; height: 100%; display: block; }

    /* UI Parts */
    .h { font-weight: 800; margin: 0 0 10px; font-size: 15px; }
    .muted { color: var(--muted); font-size: 12px; line-height: 1.5; }
    .box {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 12px;
      background: #fff;
    }
    .pill {
      display: inline-block;
      font-size: 11px;
      padding: 2px 8px;
      border: 1px solid var(--border);
      border-radius: 999px;
      background: #fff;
      color: var(--muted);
    }

    /* Filter Tabs (index.html style) */
    .filter-tabs {
      display: flex;
      background: #f3f4f6;
      border-radius: 8px;
      padding: 2px;
      margin-bottom: 8px;
    }
    .filter-tabs button {
      flex: 1;
      border: none;
      padding: 6px 4px;
      font-size: 11px;
      font-weight: bold;
      background: none;
      color: var(--muted);
      cursor: pointer;
      border-radius: 6px;
    }
    .filter-tabs button.active {
      background: #fff;
      color: #111827;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }

    input[type="text"], select {
      width: 100%; box-sizing: border-box; padding: 10px;
      border: 1px solid #d1d5db; border-radius: 10px;
      background: #fff; font-size: 14px; margin-bottom: 8px;
    }
    button.primary-btn {
      width: 100%; padding: 12px; border: 1px solid #d1d5db;
      border-radius: 10px; background: #fff; cursor: pointer;
      font-weight: 900; transition: background 0.2s;
    }
    button.primary-btn:hover { background: #f9fafb; }

    #cyLoading {
      position: absolute; inset: 0; display: none; place-items: center;
      background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(4px); z-index: 100;
    }
    #cyLoading.show { display: grid; }

    @media (max-width: 1000px) {
      #app { grid-template-columns: 1fr; }
      #left, #right, #cyWrap { display: none; height: calc(100vh - 60px); }
      body.tab-left #left { display: block; }
      body.tab-cy #cyWrap { display: block; }
      body.tab-right #right { display: block; }
      #mobileTabs {
        position: fixed; bottom: 0; left: 0; right: 0; height: 60px;
        display: flex; background: #fff; border-top: 1px solid var(--border);
        padding: 5px; box-sizing: border-box; z-index: 1000;
      }
      #mobileTabs button { flex: 1; border: none; background: none; font-size: 13px; font-weight: bold; color: var(--muted); }
      #mobileTabs button.active { color: var(--wine); background: var(--pink-100); border-radius: 8px; }
    }
  </style>
</head>

<body class="tab-cy">
  <div id="app">
    <div id="left">
      <div class="h" style="font-size:18px;">祖先のみ表示</div>
      <p class="muted">選択した品種のルーツを家系図形式で表示します。</p>

      <div class="box">
        <div class="h" style="margin:0 0 8px;">品種リスト</div>
        
        <div class="filter-tabs">
          <button type="button" data-filter="all" class="active">全品種</button>
          <button type="button" data-filter="registered">登録品種</button>
          <button type="button" data-filter="no-parents">親が不明</button>
        </div>

        <input id="q" type="text" placeholder="品種名 / 登録者で検索" />

        <div style="display:flex; gap:8px; align-items:center; margin-top:8px;">
          <span id="listBadge" class="pill">準備中…</span>
        </div>

        <div id="listWrap" style="margin-top:8px; max-height: 40vh; overflow:auto; border:1px solid var(--border); border-radius:10px; background:#fff;">
          <div class="muted" style="padding:10px;">読み込み中…</div>
        </div>
      </div>

      <div class="box">
        <div class="h">品種名</div>
        <input id="name" type="text" list="cultivars" placeholder="例：とちおとめ" />
        <datalist id="cultivars"></datalist>

        <div class="h" style="margin-top:10px;">遡る世代</div>
        <select id="depth">
          <option value="1">1代前（親）</option>
          <option value="2" selected>2代前（祖父母）</option>
          <option value="3">3代前（曾祖父母）</option>
          <option value="4">4代前（高祖父母）</option>
          <option value="5">5代前</option>
          <option value="6">6代前</option>
        </select>

        <label style="display:flex; align-items:center; gap:8px; font-size:13px; margin:10px 0;">
          <input id="includeUnknown" type="checkbox" /> 不明(unknown)を含める
        </label>

        <button id="run" class="primary-btn" type="button">系統図を表示</button>
      </div>
      
      <div class="box">
        <div class="h">ステータス</div>
        <span id="badge" class="pill">準備中...</span>
        <div id="info-status" class="muted" style="margin-top:8px;">品種を入力してください。</div>
      </div>

      <a class="muted" href="./" style="display:block; text-align:center;">← トップページに戻る</a>
    </div>

    <div id="cyWrap">
      <div id="cy"></div>
      <div id="cyLoading">
        <div style="text-align:center; background:white; padding:20px; border-radius:12px; border:1px solid var(--border);">
          <div style="font-weight:bold;">描画中...</div>
          <div class="muted">家系図を計算しています</div>
        </div>
      </div>
    </div>

    <div id="right">
      <div class="h">詳細情報</div>
      <div id="detail">
        <div class="box muted">ノードをクリックすると情報が表示されます。</div>
      </div>
      <div class="h">凡例</div>
      <div class="box muted">
        母方：実線 / 父方：破線 / 不明：点線
      </div>
      <div class="muted" style="margin-top:20px; text-align:center;">© Strawberry Pedigree</div>
    </div>
  </div>

  <div id="mobileTabs">
    <button type="button" data-tab="left">設定</button>
    <button type="button" data-tab="cy" class="active">系統図</button>
    <button type="button" data-tab="right">情報</button>
  </div>

<script>
  if (window.cytoscape && window.cytoscapeDagre) {
    cytoscape.use(cytoscapeDagre);
  }

  let allData = null;
  let nodeById = new Map();
  let nodeByLabel = new Map();
  let parentsOf = new Map();
  let cy = null;
  let renderToken = 0;
  let currentFilter = 'all'; // 現在のフィルタ状態

  function setTab(name) {
    document.body.classList.remove('tab-left', 'tab-cy', 'tab-right');
    document.body.classList.add(`tab-${name}`);
    document.querySelectorAll('#mobileTabs button').forEach(b => {
      b.classList.toggle('active', b.dataset.tab === name);
    });
    if (cy) { setTimeout(() => { cy.resize(); cy.fit(); }, 100); }
  }

  document.querySelectorAll('#mobileTabs button').forEach(btn => {
    btn.addEventListener('click', () => setTab(btn.dataset.tab));
  });

  // フィルタタブのクリックイベント
  document.querySelectorAll('.filter-tabs button').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.filter-tabs button').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      currentFilter = btn.dataset.filter;
      updateList();
    });
  });

  function esc(s){
    return (s ?? '').toString().replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
  }

  function setDetail(n){
    const box = document.getElementById('detail');
    if(!box || !n) {
      box.innerHTML = '<div class="box muted">ノードをクリックすると情報が表示されます。</div>';
      return;
    }
    const d = n.data();
    const year = d.year ? `<div><b>品種登録年</b>：${esc(d.year)}</div>` : '';
    const inst = d.institute ? `<div><b>品種登録者</b>：${esc(d.institute)}</div>` : '';
    const incomers = n.incomers('edge');
    const mothers = incomers.filter(e => e.data('role') === 'mother').sources().map(x => x.data('label'));
    const fathers = incomers.filter(e => e.data('role') === 'father').sources().map(x => x.data('label'));
    const outgoers = n.outgoers('edge');
    const children = outgoers.targets().map(x => x.data('label'));

    box.innerHTML = `
      <div class="box">
        <div class="h" style="margin:0 0 6px; color:var(--wine);">${esc(d.label)}</div>
        ${year} ${inst}
        <div><b>母</b>：${Array.from(new Set(mothers)).join(', ') || '-'}</div>
        <div><b>父</b>：${Array.from(new Set(fathers)).join(', ') || '-'}</div>
        <div style="margin-top:8px;"><b>子</b><div>${Array.from(new Set(children)).join(', ') || '-'}</div></div>
        ${d.sources ? `<div style="margin-top:8px;"><b>情報源</b><div class="muted">${esc(d.sources)}</div></div>` : ''}
      </div>
    `;
  }

  function parseElements(elements) {
    nodeById.clear();
    nodeByLabel.clear();
    parentsOf.clear();
    const nodes = elements.filter(e => e.data && e.data.id && e.data.label && !e.data.source);
    const edges = elements.filter(e => e.data && e.data.source && e.data.target);

    nodes.forEach(n => {
      const id = String(n.data.id);
      nodeById.set(id, n);
      const label = String(n.data.label).trim();
      if (!nodeByLabel.has(label)) nodeByLabel.set(label, id);
    });

    edges.forEach(e => {
      const target = String(e.data.target);
      if (!parentsOf.has(target)) parentsOf.set(target, []);
      parentsOf.get(target).push({ parentId: String(e.data.source), role: e.data.role || '' });
    });

    const dl = document.getElementById('cultivars');
    Array.from(nodeByLabel.keys()).sort().forEach(l => {
      const opt = document.createElement('option');
      opt.value = l;
      dl.appendChild(opt);
    });
  }

  function updateList(){
    const term = (document.getElementById('q')?.value ?? '').trim().toLowerCase();
    let rows = [];
    
    for(const [id, n] of nodeById.entries()){
      const label = (n.data?.label ?? '').toString();
      const inst = (n.data?.institute ?? '').toString();
      const isUnknown = ['不明','unknown'].includes(label.toLowerCase());
      
      if(isUnknown) continue;

      // フィルタリング
      if (currentFilter === 'registered' && !n.data.year) continue;
      if (currentFilter === 'no-parents' && parentsOf.has(id)) continue;

      // 検索ワード
      if (term && !label.toLowerCase().includes(term) && !inst.toLowerCase().includes(term)) continue;

      rows.push({ id, data: n.data });
    }

    rows.sort((a,b) => (a.data.label).localeCompare(b.data.label, 'ja'));
    renderList(rows, term ? `検索結果：${rows.length}件` : `件数：${rows.length}件`);
  }

  function renderList(rows, badgeText){
    const wrap = document.getElementById('listWrap');
    document.getElementById('listBadge').textContent = badgeText;
    if(!rows.length){
      wrap.innerHTML = `<div class="muted" style="padding:10px;">該当なし</div>`;
      return;
    }

    wrap.innerHTML = `
      <table style="border-collapse:collapse; width:100%; font-size:12px;">
        <thead>
          <tr style="position:sticky; top:0; background:#fff; box-shadow:0 1px var(--border);">
            <th style="text-align:left; padding:8px 10px;">品種</th>
            <th style="text-align:left; padding:8px 10px; width:20%;">登録年</th>
          </tr>
        </thead>
        <tbody>
          ${rows.map(r => `<tr data-label="${esc(r.data.label)}" style="cursor:pointer; border-bottom:1px solid #f9fafb;">
            <td style="padding:8px 10px;">${esc(r.data.label)}<br><small class="muted">${esc(r.data.institute || '')}</small></td>
            <td style="padding:8px 10px;" class="muted">${esc(r.data.year || '-')}</td>
          </tr>`).join('')}
        </tbody>
      </table>`;

    wrap.querySelectorAll('tbody tr').forEach(tr => {
      tr.addEventListener('click', () => {
        document.getElementById('name').value = tr.dataset.label;
        run();
        if(window.innerWidth <= 1000) setTab('cy');
      });
    });
  }

  function collectAncestors(startId, maxDepth, includeUnknown) {
    const keepNodes = new Set([startId]);
    const keepEdges = [];
    let frontier = [startId];

    for (let d = 0; d < maxDepth; d++) {
      let nextFrontier = [];
      frontier.forEach(childId => {
        const parents = parentsOf.get(childId) || [];
        parents.forEach(p => {
          const parentNode = nodeById.get(p.parentId);
          if (!parentNode) return;
          const label = String(parentNode.data.label).toLowerCase();
          const isUnknown = ['不明', 'unknown'].includes(label);
          if (!includeUnknown && isUnknown) return;
          keepNodes.add(p.parentId);
          nextFrontier.push(p.parentId);
          keepEdges.push({ data: { source: p.parentId, target: childId, role: isUnknown ? 'unknown' : p.role } });
        });
      });
      frontier = nextFrontier;
      if (frontier.length === 0) break;
    }
    return Array.from(keepNodes).map(id => nodeById.get(id)).concat(keepEdges);
  }

  function initCy() {
    if (cy) return;
    cy = cytoscape({
      container: document.getElementById('cy'),
      style: [
        { selector: 'node', style: {
          'label': 'data(label)', 'font-size': '12px', 'text-valign': 'center', 'text-halign': 'center',
          'background-color': '#FCE7F3', 'border-width': 1, 'border-color': '#F9A8D4',
          'width': 'label', 'padding': '10px', 'shape': 'round-rectangle', 'color': '#831843'
        }},
        { selector: 'edge', style: {
          'curve-style': 'unbundled-bezier', 'target-arrow-shape': 'triangle', 'width': 2,
          'line-color': '#D1B0C2', 'target-arrow-color': '#D1B0C2'
        }},
        { selector: 'edge[role="mother"]', style: { 'line-style': 'solid' } },
        { selector: 'edge[role="father"]', style: { 'line-style': 'dashed' } },
        { selector: 'edge[role="unknown"]', style: { 'line-style': 'dotted', 'line-color': '#ccc' } }
      ]
    });
    cy.on('tap', 'node', (evt) => {
      if (window.innerWidth <= 1000) setTab('right');
      setDetail(evt.target);
    });
    cy.on('tap', (evt) => { if(evt.target === cy) setDetail(null); });
  }

  async function run() {
    const label = document.getElementById('name').value.trim();
    const startId = nodeByLabel.get(label);
    if (!startId) { document.getElementById('badge').textContent = '未発見'; return; }

    const depth = parseInt(document.getElementById('depth').value);
    const includeUnknown = document.getElementById('includeUnknown').checked;
    const elements = collectAncestors(startId, depth, includeUnknown);

    document.getElementById('cyLoading').classList.add('show');
    const myToken = ++renderToken;
    initCy();

    cy.batch(() => { cy.elements().remove(); cy.add(elements); });

    setTimeout(() => {
      if (myToken !== renderToken) return;
      cy.layout({
        name: 'dagre', rankDir: 'LR', animate: true,
        stop: () => {
          cy.fit(undefined, 40);
          document.getElementById('cyLoading').classList.remove('show');
          document.getElementById('badge').textContent = `表示: ${label}`;
          document.getElementById('info-status').textContent = `${elements.length} 個の要素を表示。`;
        }
      }).run();
    }, 50);
  }

  async function load() {
    try {
      const res = await fetch("elements.json?ts=" + Date.now());
      allData = await res.json();
      parseElements(allData.elements || allData);
      updateList();
      document.getElementById('q').addEventListener('input', updateList);
      document.getElementById('badge').textContent = '準備完了';
    } catch (e) { document.getElementById('badge').textContent = '失敗'; }
  }

  document.getElementById('run').addEventListener('click', run);
  window.onload = load;
</script>
</body>
</html>
