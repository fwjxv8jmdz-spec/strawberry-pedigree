<script>
  let all = null;
  let nodeById = new Map();
  let nodeByLabel = new Map();
  let parentsOf = new Map();
  let cy = null;

  const UNKNOWN_LABELS = new Set(['unknown','不明']);

  function isUnknownLabel(label){
    const t = (label ?? '').toString().trim().toLowerCase();
    return UNKNOWN_LABELS.has(t);
  }

  function setBadge(text){
    document.getElementById('badge').textContent = text;
  }

  function getParam(name){
    const u = new URL(location.href);
    return u.searchParams.get(name);
  }

  function setParam(name, value){
    const u = new URL(location.href);
    if(value === null || value === undefined || value === '') u.searchParams.delete(name);
    else u.searchParams.set(name, value);
    history.replaceState({}, '', u.toString());
  }

  function parseElements(elements){
    nodeById = new Map();
    nodeByLabel = new Map();
    parentsOf = new Map();

    const nodes = elements.filter(e => e.group === 'nodes' || e.data?.label);
    const edges = elements.filter(e => e.group === 'edges' || (e.data?.source && e.data?.target));

    for(const n of nodes){
      // ★ ここは elements.json の仕様次第。
      // 今はいったん「data.idがあればそれ、なければ Cytoscape の id」を使う
      const realId = (n.data && n.data.id !== undefined && n.data.id !== null && String(n.data.id).trim() !== '')
        ? String(n.data.id)
        : String(n.data?.id ?? n.id ?? n.data?.label);

      nodeById.set(realId, n);

      const label = (n.data?.label ?? '').toString().trim();
      if(label && !nodeByLabel.has(label)) nodeByLabel.set(label, realId);
    }

    for(const e of edges){
      const d = e.data || {};
      const source = String(d.source);
      const target = String(d.target);
      const role = d.role || '';
      const edgeId = d.id ? String(d.id) : undefined;

      if(!parentsOf.has(target)) parentsOf.set(target, []);
      parentsOf.get(target).push({ parentId: source, role, edgeId });
    }

    // datalist
    const dl = document.getElementById('cultivars');
    dl.innerHTML = '';
    for(const label of nodeByLabel.keys()){
      const opt = document.createElement('option');
      opt.value = label;
      dl.appendChild(opt);
    }
  }

  function collectAncestors(startId, depthN, includeUnknown){
    const keepNodes = new Set([startId]);
    const keepEdges = new Set();

    let frontier = new Set([startId]);

    for(let gen = 1; gen <= depthN; gen++){
      const next = new Set();

      for(const childId of frontier){
        const ps = parentsOf.get(childId) || [];
        for(const p of ps){
          const parentId = p.parentId;
          const parentNode = nodeById.get(parentId);
          if(!parentNode) continue;

          const label = (parentNode.data?.label ?? '').toString().trim();
          if(!includeUnknown && isUnknownLabel(label)) continue;

          keepNodes.add(parentId);
          next.add(parentId);

          const k = p.edgeId ? `id:${p.edgeId}` : `st:${parentId}=>${childId}|${p.role}`;
          keepEdges.add(k);
        }
      }

      frontier = next;
      if(frontier.size === 0) break;
    }

    const out = [];

    // nodes
    for(const nid of keepNodes){
      const n = nodeById.get(nid);
      if(n) out.push(n);
    }

    // edges
    const edges = all.filter(e => (e.group === 'edges') || (e.data?.source && e.data?.target));
    for(const e of edges){
      const d = e.data || {};
      const s = String(d.source), t = String(d.target);
      if(!keepNodes.has(s) || !keepNodes.has(t)) continue;

      const k = d.id ? `id:${String(d.id)}` : `st:${s}=>${t}|${d.role || ''}`;
      if(keepEdges.has(k)) out.push(e);
    }

    return { elements: out, nodeCount: keepNodes.size, edgeCount: Math.max(0, out.length - keepNodes.size) };
  }

  function initCy(part){
    if(cy) cy.destroy();

    cy = cytoscape({
      container: document.getElementById('cy'),
      elements: part,
      style: [
        {
          selector: 'node',
          style: {
            'label': 'data(label)',
            'font-size': 12,
            'text-wrap': 'wrap',
            'text-max-width': 160,
            'text-valign': 'center',
            'text-halign': 'center',
            'background-color': '#FCE7F3',
            'border-width': 1.8,
            'border-color': '#FFDEEB',
            'color': '#831843',
            'width': 'label',
            'padding': '12px',
            'shape': 'round-rectangle'
          }
        },
        {
          selector: 'edge',
          style: {
            'target-arrow-shape': 'triangle',
            'target-arrow-fill': 'filled',
            'arrow-scale': 1.2,
            'width': 2,
            'line-color': '#D1B0C2',
            'target-arrow-color': '#D1B0C2',
            'curve-style': 'unbundled-bezier',
            'edge-distances': 'node-position'
          }
        },
        { selector: 'edge[role="mother"]', style: { 'line-style': 'solid',  'control-point-distance': 30, 'control-point-weight': 0.5 } },
        { selector: 'edge[role="father"]', style: { 'line-style': 'dashed', 'control-point-distance': -30,'control-point-weight': 0.5 } },
        { selector: 'edge[role="unknown"]', style: { 'line-style': 'dotted','control-point-distance': 18,'control-point-weight': 0.5 } },
      ],
      layout: { name: 'preset' }
    });

    requestAnimationFrame(() => {
      cy.resize();

      const layout = cy.layout({
        name: 'dagre',
        rankDir: 'LR',
        nodeSep: 20,
        edgeSep: 6,
        rankSep: 90,
        padding: 20,
        nodeDimensionsIncludeLabels: true,
        animate: false
      });

      layout.on('layoutstop', () => cy.fit(undefined, 30));
      layout.run();
    });
  }

  function run(){
    if(!all) return;

    const label = (document.getElementById('name').value ?? '').toString().trim();
    const depth = parseInt(document.getElementById('depth').value, 10);
    const includeUnknown = !!document.getElementById('includeUnknown').checked;

    if(!label){
      setBadge('品種名を入力してください');
      return;
    }

    const startId = nodeByLabel.get(label);
    if(!startId){
      setBadge('見つかりません（表記ゆれ注意）');
      return;
    }

    setParam('name', label);
    setParam('n', String(depth));
    setParam('u', includeUnknown ? '1' : '0');

    const { elements, nodeCount, edgeCount } = collectAncestors(startId, depth, includeUnknown);
    initCy(elements);

    setBadge(`ノード ${nodeCount} / エッジ ${edgeCount}（${label}, N=${depth}）`);
  }

  async function load(){
    try{
      const res = await fetch("/strawberry-pedigree/elements.json?ts=" + Date.now(), { cache: "no-store" });
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      all = await res.json();
      parseElements(all);

      const pName = getParam('name');
      const pN = getParam('n');
      const pU = getParam('u');

      if(pName) document.getElementById('name').value = pName;
      if(pN) document.getElementById('depth').value = pN;
      if(pU) document.getElementById('includeUnknown').checked = (pU === '1');

      setBadge('準備OK');
      if(pName) run();
    }catch(e){
      setBadge('読み込み失敗');
      alert('elements.json の読み込みに失敗しました: ' + e.message);
    }
  }

window.addEventListener('DOMContentLoaded', () => {
  const btnRun = document.getElementById('run');
  const inpName = document.getElementById('name');
  const selDepth = document.getElementById('depth');
  const chkUnknown = document.getElementById('includeUnknown');

  if(!btnRun || !inpName || !selDepth || !chkUnknown){
    console.error("Required DOM not found:", {btnRun, inpName, selDepth, chkUnknown});
    setBadge("画面部品が見つかりません（HTMLのidを確認）");
    return;
  }

  btnRun.addEventListener('click', run);
  inpName.addEventListener('keydown', (e)=>{ if(e.key === 'Enter') run(); });

  let t = null;
  selDepth.addEventListener('change', ()=>{ clearTimeout(t); t=setTimeout(run, 120); });
  chkUnknown.addEventListener('change', ()=>{ clearTimeout(t); t=setTimeout(run, 120); });

  load();
});

</script>



