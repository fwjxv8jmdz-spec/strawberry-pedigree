<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Strawberry Pedigree (Cytoscape.js)</title>
  <style>
    :root{
      --bg:#fff7fb;
      --panel:#ffffff;
      --panelBorder:#ffd3e7;
      --accent:#ff6aa6;
      --accent2:#ff9cc6;
      --text:#2b2b2b;
      --muted:#6b6b6b;
    }
    html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, "Segoe UI", "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif; background: var(--bg); color: var(--text); }
    #app { height: 100%; display: grid; grid-template-rows: auto 1fr; }
    header{
      display:flex; gap:12px; flex-wrap:wrap;
      align-items:center;
      padding:10px 12px;
      background: linear-gradient(90deg, #fff 0%, #ffe6f1 100%);
      border-bottom: 1px solid var(--panelBorder);
      position: sticky; top:0; z-index: 10;
    }
    .box{
      background: var(--panel);
      border: 1px solid var(--panelBorder);
      border-radius: 12px;
      padding: 8px 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.04);
      display:flex; gap:10px; align-items:center;
    }
    .box label{ font-size: 12px; color: var(--muted); }
    select, input[type="text"]{
      font-size: 13px;
      border: 1px solid #ffd3e7;
      border-radius: 10px;
      padding: 6px 10px;
      outline: none;
      background:#fff;
    }
    button{
      border: 0;
      border-radius: 12px;
      padding: 8px 12px;
      cursor: pointer;
      color: #fff;
      background: linear-gradient(180deg, var(--accent) 0%, var(--accent2) 100%);
      box-shadow: 0 4px 14px rgba(255,106,166,0.35);
      font-weight: 600;
      font-size: 13px;
    }
    button:active{ transform: translateY(1px); }
    #cy { width: 100%; height: 100%; }
    .hint{ font-size: 12px; color: var(--muted); }
    .sep{ width:1px; height:28px; background:#ffd3e7; margin:0 4px; }
  </style>

  <!--
    ★重要★
    CDN / raw.github がブロックされている前提なので、
    ここは「ローカルに置いたJS」を読み込む形にしてください。

    例:
      ./lib/cytoscape.min.js
      ./lib/dagre.min.js
      ./lib/cytoscape-dagre.js

    すでに dagre が動いている完成版HTMLがあるとのことなので、
    その時に使っているローカルパスに合わせて書き換えてOKです。
  -->
  <script src="./lib/cytoscape.min.js"></script>

  <!-- dagre layout (すでにローカルで動いている前提) -->
  <script src="./lib/dagre.min.js"></script>
  <script src="./lib/cytoscape-dagre.js"></script>
</head>

<body>
<div id="app">
  <header>
    <div class="box">
      <label for="layoutSel">Layout</label>
      <!-- ★breadthfirst / concentric / circle / grid を削除し、dagre/cose のみに -->
      <select id="layoutSel">
        <option value="dagre">dagre</option>
        <option value="cose">cose</option>
      </select>
      <button id="btnLayout">レイアウト実行</button>
    </div>

    <div class="sep"></div>

    <div class="box">
      <label for="qName">品種名</label>
      <input id="qName" type="text" placeholder="品種名で検索" />
      <label for="qBreeder">登録者</label>
      <input id="qBreeder" type="text" placeholder="登録者で検索" />
      <button id="btnFind">検索</button>
      <button id="btnReset">リセット</button>
    </div>

    <div class="sep"></div>

    <div class="hint">
      cose の「invalid endpoints」対策：<b>ノード重なりを減らす</b>＋<b>重なったエッジだけ straight に落とす</b>
    </div>
  </header>

  <div id="cy"></div>
</div>

<script>
/** =========================
 *  ここに要素（nodes/edges）を入れる
 *  既存の完成版HTMLの elements をそのまま差し替えればOK
 *  ========================= */
const elements = {
  nodes: [
    // 例（置き換えてください）
    { data: { id: "A", label: "Parent A", breeder: "Breeder X" } },
    { data: { id: "B", label: "Parent B", breeder: "Breeder Y" } },
    { data: { id: "C", label: "Child C", breeder: "Breeder Z" } },
  ],
  edges: [
    // 例：母→子、父→子（あなたの既存データ構造に合わせてOK）
    // id はユニーク推奨
    { data: { id: "e1", source: "A", target: "C", rel: "mother" } },
    { data: { id: "e2", source: "B", target: "C", rel: "father" } },
  ]
};

/** =========================
 *  スタイル
 *  ========================= */
const style = [
  {
    selector: "node",
    style: {
      "shape": "round-rectangle",
      "background-color": "#fff",
      "border-width": 2,
      "border-color": "#ff9cc6",
      "color": "#2b2b2b",

      // ラベルをノード内で折り返し、横長になりやすくする
      "label": "data(label)",
      "text-wrap": "wrap",
      "text-max-width": 160,
      "text-valign": "center",
      "text-halign": "center",
      "font-size": 12,
      "padding": "10px",

      // ノードサイズをラベルに寄せる（重なり回避にも効く）
      "width": "label",
      "height": "label"
    }
  },

  // 通常エッジ：曲線（あなたの「母は時計回り、父は反時計回り」の表現を維持）
  {
    selector: "edge",
    style: {
      "width": 2,
      "line-color": "#ff6aa6",
      "target-arrow-color": "#ff6aa6",
      "target-arrow-shape": "triangle",
      "arrow-scale": 0.9,

      // 基本はベジェ曲線
      "curve-style": "bezier",

      // ラベル（必要なら）
      // "label": "data(rel)",
      // "font-size": 10,
      // "text-rotation": "autorotate",
      // "color": "#6b6b6b",
    }
  },

  // 母→子（時計回りのカーブっぽく）
  {
    selector: 'edge[rel = "mother"]',
    style: {
      "control-point-step-size": 35,
      "control-point-distance": 60,
      "control-point-weight": 0.25
    }
  },
  // 父→子（反時計回りのカーブっぽく）
  {
    selector: 'edge[rel = "father"]',
    style: {
      "control-point-step-size": 35,
      "control-point-distance": -60,
      "control-point-weight": 0.25
    }
  },

  // ★重なり検出されたエッジだけ straight に落とす（invalid endpoints 回避）
  {
    selector: "edge.overlapFix",
    style: {
      "curve-style": "straight"
    }
  },

  // 検索ハイライト
  { selector: "node.hit", style: { "border-color": "#ff2f7d", "border-width": 4 } },
  { selector: "node.dim", style: { "opacity": 0.25 } },
  { selector: "edge.dim", style: { "opacity": 0.15 } },
];

/** =========================
 *  Cytoscape 初期化
 *  ========================= */
const cy = cytoscape({
  container: document.getElementById("cy"),
  elements,
  style,
  wheelSensitivity: 0.18,
});

/** =========================
 *  レイアウト定義（dagre / cose のみ）
 *  ========================= */
const layoutPresets = {
  dagre: {
    name: "dagre",
    rankDir: "TB",
    nodeSep: 25,
    edgeSep: 10,
    rankSep: 60,
    spacingFactor: 1.1,
    animate: true,
    animationDuration: 350,
    fit: true,
    padding: 20
  },

  // ★cose：重なり回避を強める
  cose: {
    name: "cose",
    animate: true,
    animationDuration: 500,
    fit: true,
    padding: 30,

    // 重なり回避（ここが主対策）
    avoidOverlap: true,
    nodeOverlap: 20,               // 重なり許容量（大きいほど離す）
    nodeDimensionsIncludeLabels: true,

    // 余白・反発など
    componentSpacing: 90,
    idealEdgeLength: 140,
    edgeElasticity: 0.25,
    nodeRepulsion: 90000,          // 重要：重なりが起きるなら上げる
    gravity: 0.25,

    // 初期位置ランダム（同一点スタートで重なりが起きやすい時に有効）
    randomize: true,

    // 実行回数・収束
    numIter: 1200,
    initialTemp: 250,
    coolingFactor: 0.98,
    minTemp: 1.0
  }
};

function runLayout(layoutName){
  const opts = layoutPresets[layoutName] || layoutPresets.dagre;

  // エッジ重なり対策のクラスをいったん外す（毎回評価し直す）
  cy.edges().removeClass("overlapFix");

  const lay = cy.layout(opts);

  // layoutstop 後に「まだ重なっているノード間のエッジ」だけ curve-style を straight にする
  lay.on("layoutstop", () => {
    applyOverlapEdgeFix();
  });

  lay.run();
}

function applyOverlapEdgeFix(){
  // 同一点 / ほぼ同一点のノード間エッジは bezier の制御点が作れず
  // "invalid endpoints" が出ることがあるので、該当エッジだけ straight に落とす。
  const EPS = 0.5; // px（しきい値）
  cy.edges().forEach(e => {
    const s = e.source();
    const t = e.target();
    if (!s || !t) return;

    const ps = s.position();
    const pt = t.position();
    const dx = ps.x - pt.x;
    const dy = ps.y - pt.y;
    const dist = Math.sqrt(dx*dx + dy*dy);

    if (dist < EPS) {
      e.addClass("overlapFix");
    }
  });

  // 見た目が変わるので必要なら再描画
  cy.resize();
  cy.render();
}

/** =========================
 *  検索（品種名 / 登録者）
 *  ========================= */
function normalize(s){ return (s ?? "").toString().trim().toLowerCase(); }

function resetSearch(){
  cy.nodes().removeClass("hit dim");
  cy.edges().removeClass("dim");
}

function applySearch(){
  const qName = normalize(document.getElementById("qName").value);
  const qBreeder = normalize(document.getElementById("qBreeder").value);

  resetSearch();

  if (!qName && !qBreeder) return;

  const hits = cy.nodes().filter(n => {
    const label = normalize(n.data("label"));
    const breeder = normalize(n.data("breeder"));
    const okName = qName ? label.includes(qName) : true;
    const okBreeder = qBreeder ? breeder.includes(qBreeder) : true;
    return okName && okBreeder;
  });

  // dim
  const nonHits = cy.nodes().difference(hits);
  nonHits.addClass("dim");
  cy.edges().addClass("dim");

  // hit
  hits.removeClass("dim").addClass("hit");

  // hit を中心に表示
  if (hits.length > 0){
    cy.animate({
      fit: { eles: hits, padding: 80 },
      duration: 280
    });
  }
}

/** =========================
 *  UI
 *  ========================= */
document.getElementById("btnLayout").addEventListener("click", () => {
  const name = document.getElementById("layoutSel").value;
  runLayout(name);
});

document.getElementById("layoutSel").addEventListener("change", () => {
  runLayout(document.getElementById("layoutSel").value);
});

document.getElementById("btnFind").addEventListener("click", applySearch);
document.getElementById("btnReset").addEventListener("click", () => {
  document.getElementById("qName").value = "";
  document.getElementById("qBreeder").value = "";
  resetSearch();
});

document.getElementById("qName").addEventListener("keydown", (e) => {
  if (e.key === "Enter") applySearch();
});
document.getElementById("qBreeder").addEventListener("keydown", (e) => {
  if (e.key === "Enter") applySearch();
});

/** =========================
 *  初期レイアウト
 *  ========================= */
runLayout("dagre");
</script>
</body>
</html>
