<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Strawberry Pedigree</title>

  <!-- Cytoscape core -->
  <script src="https://unpkg.com/cytoscape@3.27.0/dist/cytoscape.min.js"></script>

  <!-- Layout plugins -->
  <script src="https://unpkg.com/dagre@0.8.5/dist/dagre.min.js"></script>
  <script src="https://unpkg.com/cytoscape-dagre/cytoscape-dagre.js"></script>

  <style>
    body { margin: 0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif; }
    #app { display: grid; grid-template-columns: 320px 1fr 340px; height: 100vh; }
    #left, #right { padding: 12px; border-right: 1px solid #e5e7eb; overflow: auto; }
    #right { border-right: none; border-left: 1px solid #e5e7eb; }
    #cy { width: 100%; height: 100%; }

    .h { font-weight: 700; margin: 6px 0 10px; }
    .muted { color: #6b7280; font-size: 12px; line-height: 1.4; }
    .box { border: 1px solid #e5e7eb; border-radius: 10px; padding: 10px; margin: 10px 0; }

    input[type="text"] {
      width: 100%;
      box-sizing: border-box;
      padding: 10px;
      border: 1px solid #d1d5db;
      border-radius: 10px;
    }

    button {
      padding: 8px 10px;
      border: 1px solid #d1d5db;
      background: #fff;
      border-radius: 10px;
      cursor: pointer;
    }
    button:hover { background: #f9fafb; }

    .row { display: flex; gap: 8px; }
    .row > * { flex: 1; }

    .tag {
      display:inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      font-size: 12px;
      margin-right: 6px;
    }

    a { color: #2563eb; text-decoration: none; }
    a:hover { text-decoration: underline; }
  </style>
</head>

<body>
<div id="app">
  <div id="left">
    <div class="h">検索</div>
    <input id="q" type="text"
      placeholder="品種名 / 品種登録者で検索（例：とちおとめ、栃木県）" />

    <div class="row" style="margin-top:10px;">
      <button id="fit">全体表示</button>
      <button id="clear">選択解除</button>
    </div>

    <div class="box">
      <div class="h" style="margin:0 0 6px;">レイアウト</div>
      <button id="layout_dagre">配置リセット（親→子）</button>
    </div>

    <div class="box">
      <div class="h" style="margin:0 0 6px;">凡例</div>
      <div><span class="tag">母 → 子</span> 実線</div>
      <div><span class="tag">父 → 子</span> 破線</div>
    </div>

    <div class="box">
      <div class="h" style="margin:0 0 6px;">読み込み</div>
      <div id="status" class="muted">elements.json を読み込み中…</div>
    </div>
  </div>

  <div id="cy"></div>

  <div id="right">
    <div class="h">詳細</div>
    <div id="detail" class="muted">ノードをクリックすると情報が表示されます。</div>
  </div>
</div>

<script>
let cy = null;

function esc(s){
  return (s ?? '').toString()
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;');
}

function uniq(arr){
  return [...new Set(arr.filter(x => x))];
}

function setDetail(n){
  if(!n){
    document.getElementById('detail').innerHTML =
      '<span class="muted">ノードをクリックすると情報が表示されます。</span>';
    return;
  }

  const d = n.data();
  const incomers = n.incomers('edge');
  const outgoers = n.outgoers('edge');

  const mothers = uniq(incomers.filter(e => e.data('role') === 'mother')
    .sources().map(x => x.data('label')));
  const fathers = uniq(incomers.filter(e => e.data('role') === 'father')
    .sources().map(x => x.data('label')));
  const children = uniq(outgoers.targets().map(x => x.data('label')));
  const crossSources = uniq(incomers.map(e => e.data('source_id')));

  document.getElementById('detail').innerHTML = `
    <div class="box">
      <div class="h">${esc(d.label)}</div>
      ${d.year ? `<div><b>品種登録年</b>：${esc(d.year)}</div>` : ''}
      ${d.institute ? `<div><b>品種登録者</b>：${esc(d.institute)}</div>` : ''}
      ${mothers.length ? `<div><b>母</b>：${mothers.map(esc).join(', ')}</div>` : ''}
      ${fathers.length ? `<div><b>父</b>：${fathers.map(esc).join(', ')}</div>` : ''}
      ${children.length ? `<div><b>子</b>：${children.map(esc).join(', ')}</div>` : ''}
      ${crossSources.length ? `<div><b>交配出典</b><br>${crossSources.map(esc).join('<br>')}</div>` : ''}
    </div>
  `;
}

function initCy(elements){
  cy = cytoscape({
    container: document.getElementById('cy'),
    elements,
    style: [
      {
        selector: 'node',
        style: {
          'label': 'data(label)',
          'background-color': '#F472B6',
          'color': '#7C2D12',
          'text-valign': 'center',
          'text-halign': 'center',
          'shape': 'round-rectangle',
          'padding': '10px'
        }
      },
      {
        selector: 'edge',
        style: {
          'curve-style': 'unbundled-bezier',
          'target-arrow-shape': 'triangle',
          'width': 2,
          'line-color': '#EC4899',
          'target-arrow-color': '#EC4899'
        }
      },
      {
        selector: 'edge[role="father"]',
        style: { 'line-style': 'dashed', 'line-color': '#F9A8D4' }
      },
      {
        selector: '.highlight',
        style: { 'border-width': 3, 'border-color': '#FB7185' }
      }
    ],
    layout: { name: 'dagre', rankDir: 'TB', padding: 30 }
  });

  cy.on('tap', 'node', e => setDetail(e.target));
  cy.on('tap', e => { if(e.target === cy) setDetail(null); });

  // ★ 検索（品種名 OR 品種登録者）
  const q = document.getElementById('q');
  q.addEventListener('input', () => {
    const term = q.value.trim().toLowerCase();
    cy.nodes().removeClass('highlight');
    if(!term) return;

    const matched = cy.nodes().filter(n => {
      const label = (n.data('label') || '').toLowerCase();
      const inst  = (n.data('institute') || '').toLowerCase();
      return label.includes(term) || inst.includes(term);
    });

    matched.addClass('highlight');
    if(matched.length){
      cy.fit(matched, 80);
    }
  });

  document.getElementById('fit').onclick = () => cy.fit(undefined, 30);
  document.getElementById('clear').onclick = () => {
    q.value = '';
    cy.nodes().removeClass('highlight');
    setDetail(null);
  };
  document.getElementById('layout_dagre').onclick =
    () => cy.layout({ name: 'dagre', rankDir: 'TB', padding: 30 }).run();
}

async function loadElements(){
  const status = document.getElementById('status');
  const res = await fetch('elements.json?ts=' + Date.now());
  const elements = await res.json();
  status.textContent = `読み込み完了：${elements.length} 要素`;
  initCy(elements);
}

loadElements();
</script>
</body>
</html>
