<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>いちご 品種系統図（交配図） | Strawberry Pedigree</title>
  <meta name="description" content="日本のいちご品種が中心の品種系統図（交配図）です。品種名や登録者で検索し、親子関係や登録情報を確認できます。研究・参考目的のデータです。">
  <link rel="canonical" href="https://fwjxv8jmdz-spec.github.io/strawberry-pedigree/">

  <!-- favicon -->
  <link rel="icon" href="icon.svg" type="image/svg+xml">
  <link rel="icon" href="icon32.png" sizes="32x32" type="image/png">
  <link rel="icon" href="icon16.png" sizes="16x16" type="image/png">

  <!-- OGP -->
  <meta property="og:type" content="website">
  <meta property="og:title" content="いちご 品種系統図（交配図） | Strawberry Pedigree">
  <meta property="og:description" content="日本のいちご品種が中心の品種系統図（交配図）です。品種名や登録者で検索し、親子関係や登録情報を確認できます。研究・参考目的のデータです。">
  <meta property="og:url" content="https://fwjxv8jmdz-spec.github.io/strawberry-pedigree/">
  <meta property="og:site_name" content="Strawberry Pedigree">

  <!-- Twitter -->
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="いちご 品種系統図（交配図） | Strawberry Pedigree">
  <meta name="twitter:description" content="いちごの品種系統図（交配図）を検索・閲覧。親子関係や登録情報を確認できます。">

  <!-- Cytoscape -->
  <script src="https://unpkg.com/cytoscape@3.27.0/dist/cytoscape.min.js"></script>
  <!-- dagre -->
  <script src="https://unpkg.com/dagre@0.8.5/dist/dagre.min.js"></script>
  <script src="https://unpkg.com/cytoscape-dagre@2.5.0/cytoscape-dagre.js"></script>

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-KJ7RR1J4L2"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-KJ7RR1J4L2');
   
    


  </script>

  <style>
    :root{
      --border:#e5e7eb;
      --muted:#6b7280;
      --pink-50:#fff1f7;
      --pink-100:#FCE7F3;
      --pink-200:#FBCFE8;
      --pink-300:#F9A8D4;
      --pink-400:#FB7185;
      --pink-500:#F472B6;
      --wine:#831843;
      --bg:#ffffff;
    }

    body { margin: 0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif; background: var(--bg); }
    a { color: #2563eb; text-decoration: none; }
    a:hover { text-decoration: underline; }

    /* desktop layout */
    #app { display: grid; grid-template-columns: 320px 1fr 360px; height: 100vh; }
    #left, #right { padding: 12px; overflow: auto; }
    #left { border-right: 1px solid var(--border); }
    #right { border-left: 1px solid var(--border); }

    /* graph wrapper */
    #cyWrap{ position: relative; width:100%; height:100%; }
    #cy { width: 100%; height: 100%; }

    .h { font-weight: 700; margin: 6px 0 10px; }
    .muted { color: var(--muted); font-size: 12px; line-height: 1.4; }
    .box { border: 1px solid var(--border); border-radius: 10px; padding: 10px; margin: 10px 0; background:#fff; }

    input[type="text"], select {
      width: 100%;
      box-sizing: border-box;
      padding: 10px;
      border: 1px solid #d1d5db;
      border-radius: 10px;
      background: #fff;
    }

    button {
      padding: 8px 10px;
      border: 1px solid #d1d5db;
      background: #fff;
      border-radius: 10px;
      cursor: pointer;
    }
    button:hover { background: #f9fafb; }

    .tag {
      display:inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      font-size: 12px;
      margin-right: 6px;
      background: #fff;
    }

    /* list */
    .listHeader {
      display:flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 8px;
      margin: 0 0 8px;
    }
    .pill {
      display:inline-block;
      font-size: 11px;
      padding: 2px 8px;
      border: 1px solid var(--border);
      border-radius: 999px;
      background: #fff;
      color: var(--muted);
      white-space: nowrap;
    }
    #listWrap {
      max-height: 42vh;
      overflow: auto;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: #fff;
      -webkit-overflow-scrolling: touch;
    }
    table { border-collapse: collapse; width: 100%; }
    thead th {
      position: sticky;
      top: 0;
      background: #fff;
      z-index: 1;
      font-size: 12px;
      text-align: left;
      padding: 8px 10px;
      border-bottom: 1px solid var(--border);
      color: #374151;
    }
    tbody td {
      font-size: 12px;
      padding: 8px 10px;
      border-bottom: 1px solid #f3f4f6;
      vertical-align: top;
      color: #111827;
    }
    tbody tr { cursor: pointer; }
    tbody tr:hover { background: var(--pink-50); }
    .td-muted { color: var(--muted); }
    .emptyRow { padding: 12px 10px; font-size: 12px; color: var(--muted); }

    /* filter segmented buttons */
    .seg { display:flex; gap: 6px; margin: 8px 0 8px; }
    .seg button{ flex: 1; font-size: 12px; padding: 8px 8px; border-radius: 999px; }
    .seg button.active{
      border-color: var(--pink-300);
      background: var(--pink-100);
      color: var(--wine);
      font-weight: 600;
    }

    /* layout buttons */
    .layoutBtns { display:flex; gap: 8px; margin-top: 6px; }
    .layoutBtns button{ flex:1; }
    .layoutBtns button.active{
      border-color: var(--pink-300);
      background: var(--pink-100);
      color: var(--wine);
      font-weight: 700;
    }

    /* ===== floating controls: zoom + dpad (mobile only) ===== */
    #floatCtrl{
      position: absolute;
      right: 12px;
      bottom: 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 50;
      pointer-events: auto;
    }
    .zcol{
      display:flex;
      flex-direction: column;
      gap: 8px;
      align-items: flex-end;
    }
    .fbtn{
      width: 44px;
      height: 44px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.92);
      backdrop-filter: blur(6px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.08);
      display: grid;
      place-items: center;
      font-size: 18px;
      font-weight: 800;
      color: #111827;
      cursor: pointer;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }
    .fbtn:active{ transform: translateY(1px); }
    .fbtn small{ font-size: 12px; font-weight: 900; }

    .dpad{
      display: grid;
      grid-template-columns: 44px 44px 44px;
      grid-template-rows: 44px 44px 44px;
      gap: 6px;
      justify-items: center;
      align-items: center;
    }
    .dpad .blank{ width:44px; height:44px; visibility:hidden; }
    .dpad .center{ font-size: 12px; }
    .dpad .arrow{ font-size: 16px; }

    /* ★ 追加：ハイライト解除ボタン（浮動） */
    #btnClearHL{
      display:none; /* JSで必要時のみ表示 */
      width: 44px;
      height: 44px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.92);
      backdrop-filter: blur(6px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.08);
      place-items: center;
      font-size: 12px;
      font-weight: 900;
      color: #111827;
      cursor: pointer;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }
    #btnClearHL:active{ transform: translateY(1px); }

    /* mobile tabs */
    #mobileTabs{ display:none; }
    .onlyMobile{ display:none; }
    .onlyDesktop{ display:block; }

    /* footer (desktop fixed) */
    footer#deskFooter{
      position: fixed;
      bottom: 6px;
      right: 10px;
      font-size: 11px;
      color: #6b7280;
      background: rgba(255,255,255,0.82);
      padding: 2px 6px;
      border-radius: 6px;
      z-index: 10;
    }

    @media (max-width: 900px) {
      #app{
        grid-template-columns: 1fr;
        grid-template-rows: auto;
        height: auto;
        min-height: 100vh;
      }
      /* hide all by default; tabs will show one */
      #left, #right, #cyWrap{ display:none; border: none; padding: 12px; }

      #cyWrap{
        padding: 0;
        height: calc(100vh - 64px);
        min-height: 520px;
      }
      #left, #right{
        height: calc(100vh - 64px);
        overflow: auto;
        -webkit-overflow-scrolling: touch;
      }

      input[type="text"], select{ padding: 12px; font-size: 16px; }
      button{ padding: 10px 12px; font-size: 14px; }

      #listWrap{ max-height: 40vh; }
      table{ min-width: 520px; }

      #mobileTabs{
        position: fixed;
        left: 0; right: 0; bottom: 0;
        display: flex;
        gap: 8px;
        padding: 10px 10px calc(10px + env(safe-area-inset-bottom));
        background: rgba(255,255,255,0.92);
        border-top: 1px solid var(--border);
        backdrop-filter: blur(8px);
        z-index: 1000;
      }
      #mobileTabs button{
        flex: 1;
        border-radius: 999px;
        font-size: 14px;
        padding: 10px 12px;
      }
      #mobileTabs button.active{
        border-color: var(--pink-300);
        background: var(--pink-100);
        color: var(--wine);
        font-weight: 800;
      }

      body.tab-left  #left{ display:block; }
      body.tab-cy    #cyWrap{ display:block; }
      body.tab-right #right{ display:block; }

      /* floating controls above tab bar */
      #floatCtrl{
        right: 12px;
        bottom: calc(84px + env(safe-area-inset-bottom));
      }

      /* ★ 長押しで文字選択/拡大メニューが出ないようにする（強） */
      #floatCtrl, #floatCtrl *{
        -webkit-user-select: none !important;
        user-select: none !important;
        -webkit-touch-callout: none !important; /* iOSの長押しメニュー抑止 */
        touch-action: manipulation;             /* 余計なジェスチャ抑制 */
      }


      .onlyMobile{ display:block; }
      .onlyDesktop{ display:none; }

      /* mobile: hide fixed footer (邪魔) */
      footer#deskFooter{ display:none; }
    }

    /* ===== loading overlay ===== */
    #cyLoading{
      position: absolute;
      inset: 0;
      display: none;              /* JSで制御 */
      place-items: center;
      background: rgba(255,255,255,0.78);
      backdrop-filter: blur(6px);
      z-index: 80;
      pointer-events: all;        /* 操作を一旦止める */
    }
    
    #cyLoading.show{ display: grid; }
    
    .loaderBox{
      width: min(360px, 86vw);
      border: 1px solid var(--border);
      border-radius: 16px;
      background: rgba(255,255,255,0.92);
      box-shadow: 0 12px 30px rgba(0,0,0,0.10);
      padding: 16px 16px 14px;
      text-align: center;
    }
    
    .loaderTitle{
      margin-top: 8px;
      font-weight: 800;
      color: #111827;
    }
    .loaderSub{
      margin-top: 4px;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.4;
    }
    
    .spinner{
      width: 28px;
      height: 28px;
      border-radius: 999px;
      border: 3px solid #e5e7eb;
      border-top-color: var(--pink-500);
      animation: spin 0.9s linear infinite;
      margin: 0 auto;
    }
    
    @keyframes spin{
      to { transform: rotate(360deg); }
    }

    
  </style>
</head>

<body>
  <div id="introDesktop" class="muted onlyDesktop" style="margin:8px 0 12px; padding:0 12px;">
    いちごの品種系統図（交配図）を可視化したサイトです。品種名や登録者で検索し、母・父・子の関係や品種登録情報を確認できます。
  </div>

  <div id="app">
    <!-- LEFT -->
    <div id="left">
      <h1 style="font-size:16px; margin:0 0 8px;">いちご 品種系統図（交配図）</h1>

      <div class="muted" style="margin:0 0 10px;">
        いちごの品種系統図（交配図）を可視化したサイトです。品種名や登録者で検索し、母・父・子の関係や品種登録情報を確認できます。
      </div>

      <div class="h">検索</div>
      <input id="q" type="text" placeholder="品種名 / 登録者で検索（例：とちおとめ、栃木県）" />

      <div class="box">
        <div class="listHeader">
          <div class="h" style="margin:0;">品種リスト</div>
          <span id="listBadge" class="pill">準備中…</span>
        </div>

        <div class="muted" style="margin:0 0 6px;">行をクリックするとその品種へ移動します。</div>

        <div class="seg" role="tablist" aria-label="品種リスト フィルタ">
          <button id="f_all" class="active" type="button">全品種</button>
          <button id="f_reg" type="button">登録品種</button>
          <button id="f_orphan" type="button">親が不明</button>
        </div>

        <div id="listWrap">
          <div class="emptyRow">elements.json 読み込み中…</div>
        </div>

        <div class="muted" style="margin-top:8px;">
          <ul style="padding-left:16px; margin:6px 0;">
            <li>全品種: 本系統図に含まれるすべての品種</li>
            <li>登録品種: 農林水産省による登録を受けた品種</li>
            <li>親が不明: 情報を募集しています。</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- GRAPH -->
    <div id="cyWrap">
      <div id="cy"></div>

      <div id="cyLoading" aria-live="polite">
      <div class="loaderBox">
        <div class="spinner" aria-hidden="true"></div>
        <div class="loaderTitle">読み込み中…</div>
        <div class="loaderSub">系統図を配置しています。しばらくお待ちください。</div>
      </div>
      </div>

      
      <!-- floating controls (mobile only) -->
      <div id="floatCtrl" class="onlyMobile" aria-label="floating controls">
        <div class="zcol" aria-label="zoom">
          <div class="fbtn" id="btnZoomIn" title="拡大">＋</div>
          <div class="fbtn" id="btnZoomOut" title="縮小">－</div>
          <div class="fbtn" id="btnFit" title="全体表示"><small>fit</small></div>

          <!-- ★ 追加：ハイライト解除（ハイライト中のみ表示） -->
          <div id="btnClearHL" title="ハイライト解除"><small>CLR</small></div>
        </div>

        <div class="dpad" aria-label="pan controls">
          <div class="blank"></div>
          <div class="fbtn arrow" id="panUp" title="上へ">▲</div>
          <div class="blank"></div>

          <div class="fbtn arrow" id="panLeft" title="左へ">◀</div>
          <div class="fbtn center" id="panCenter" title="中央へ"><small>center</small></div>
          <div class="fbtn arrow" id="panRight" title="右へ">▶</div>

          <div class="blank"></div>
          <div class="fbtn arrow" id="panDown" title="下へ">▼</div>
          <div class="blank"></div>
        </div>
      </div>
    </div>

    <!-- RIGHT -->
    <div id="right">
      <div class="h">詳細</div>
      <div id="detail" class="muted">品種名をクリックすると情報が表示されます。</div>


      <div class="box">
        <div class="h" style="margin:0 0 6px;">利用条件・免責</div>
        <div class="muted">
          本サイトのデータの利用条件は以下をご確認ください。
          <ul style="padding-left:16px; margin:6px 0;">
            <li>
              <a href="https://fwjxv8jmdz-spec.github.io/strawberry-pedigree/README.html"
                 target="_blank" rel="noopener noreferrer">利用上の注意</a>
            </li>
          </ul>
        </div>
      </div>

      <div class="box">
        <div class="h" style="margin:0 0 6px;">レイアウト</div>
        <div class="layoutBtns">
          <button id="btnCose" class="active" type="button">CoSE</button>
          <button id="btnDagre" type="button">Dagre</button>
        </div>
      </div>

      <div class="box">
        <div class="h" style="margin:0 0 6px;">問い合わせフォーム</div>
        <div class="muted">
          情報提供、誤情報の指摘、追加してほしい品種のリクエストなどを歓迎しています。ぜひ、リンク先のGoogleフォームにてお知らせください。
          お問い合わせフォームでは、確認・返信の目的で連絡先をお預かりする場合があります。詳細はフォーム内の個人情報の取り扱いをご確認ください。
          <ul style="padding-left:16px; margin:6px 0;">
            <li>
              <a href="https://docs.google.com/forms/d/e/1FAIpQLScw4ppm9q-qG53L1dYKLOBYp_AV7yECx0Q2ui8dxKajDHESaA/viewform?usp=dialog"
                 target="_blank" rel="noopener noreferrer">問い合わせフォーム</a>
            </li>
          </ul>
        </div>
      </div>

      <div class="box">
        <div class="h" style="margin:0 0 6px;">凡例</div>
        <div><span class="tag">母 → 子</span> 実線</div>
        <div><span class="tag">父 → 子</span> 破線</div>
        <div class="muted" style="margin-top:6px;">品種名をドラッグして配置変更・ピンチで拡大縮小できます。</div>
      </div>

      <!-- mobile: author block shown inside detail tab too -->
      <div class="box onlyMobile">
        <div class="muted" style="font-size:12px;">
          © 2025 Takumi Fujiki.
          <a href="https://fwjxv8jmdz-spec.github.io/strawberry-pedigree/README.html" target="_blank" rel="noopener noreferrer">利用上の注意</a>
        </div>
      </div>
    </div>
  </div>

  <!-- Mobile bottom tabs -->
  <div id="mobileTabs" aria-label="mobile tabs">
    <button type="button" data-tab="left">検索</button>
    <button type="button" data-tab="cy" class="active">系統図</button>
    <button type="button" data-tab="right">詳細</button>
  </div>

  <!-- Desktop footer (fixed) -->
  <footer id="deskFooter" class="onlyDesktop">
    © 2025 Takumi Fujiki.
    <a href="https://fwjxv8jmdz-spec.github.io/strawberry-pedigree/README.html" target="_blank" rel="noopener noreferrer">利用上の注意</a>
  </footer>

<script>
 // ★初期フォーカス候補（品種名ラベルで指定）
    const initialFocusLabels = [
      'とちおとめ',
      '福岡S7号(あまおう)',
      'とよのか',
      'さがほのか',
      '女峰'
    ];

    function pickOne(arr){
      if(!arr || !arr.length) return null;
    
      const key = 'initialFocusIndex';
      const cur = parseInt(localStorage.getItem(key) ?? '0', 10);
      const idx = Number.isFinite(cur) ? (cur % arr.length) : 0;
    
      localStorage.setItem(key, String(idx + 1));
      return arr[idx];
    }

    
    // label（品種名）から node を探す：同名が複数なら最初の1つ
    function getNodeByLabel(label){
      if(!cy) return null;
      const target = (label ?? '').toString().trim();
      if(!target) return null;
    
      const n = cy.nodes().filter(n => (n.data('label') ?? '').toString().trim() === target).first();
      return (n && n.length) ? n : null;
    }
    
    function focusInitialNode(){
      if(!cy) return false;
    
      const label = pickOne(initialFocusLabels);
      const n = getNodeByLabel(label);
    
      if(!n) return false;
    
      // まず中心へ寄せる
      cy.center(n);
    
      // 読みやすい倍率にズーム（“全体は見えなくてOK”の方針）
      const base = isMobileNow() ? 1.0 : 1.0;   // 最低倍率（好みで調整）
      const boost = isMobileNow() ? 1.2 : 1.2; // 追加ズーム（好みで調整）
    
      // 現在ズームが小さすぎる場合だけ底上げ → さらにブースト
      const next = Math.max(cy.zoom(), base) * boost;
    
      const center = { x: cy.width()/2, y: cy.height()/2 };
      cy.zoom({ level: next, renderedPosition: center });
    
      // おまけ：その品種を軽くハイライトしたいなら（不要なら削除OK）
      // selectNode(n, false);
    
      return true;}
  
function showCyLoading(msg){
  const el = document.getElementById('cyLoading');
  if(!el) return;
  if(msg){
    const sub = el.querySelector('.loaderSub');
    if(sub) sub.textContent = msg;
  }
  el.classList.add('show');
}
function hideCyLoading(){
  const el = document.getElementById('cyLoading');
  if(!el) return;
  el.classList.remove('show');
}

  
let cy = null;

const mqMobile = window.matchMedia('(max-width: 900px)');
const isMobileNow = () => mqMobile.matches;
const nodeFontSize = () => (isMobileNow() ? 18 : 12);
const textMaxWidth = () => (isMobileNow() ? 240 : 150);

let listFilter = 'all'; // 'all' | 'reg' | 'orphan'

/* ★ ハイライト状態管理 */
let hasHighlight = false;
function updateClearButtons(){
  const m = document.getElementById('btnClearHL');
  const d = document.getElementById('btnClearHLDesk');
  const show = !!hasHighlight;
  if(m) m.style.display = show ? 'grid' : 'none';
  if(d) d.disabled = !show;
}
function clearHighlight(){
  if(!cy) return;
  cy.elements().removeClass('faded');
  cy.elements().removeClass('highlight');
  setDetail(null);
  hasHighlight = false;
  updateClearButtons();
}

function esc(s){
  return (s ?? '').toString()
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;');
}
function uniq(arr){
  const seen = new Set();
  const out = [];
  for(const v of arr){
    const s = (v ?? '').toString().trim();
    if(!s) continue;
    if(seen.has(s)) continue;
    seen.add(s);
    out.push(s);
  }
  return out;
}
function isUnknownNode(n){
  const label = ((n.data('label') ?? '') + '').trim().toLowerCase();
  return (label === 'unknown' || label === '不明');
}
function isRegisteredNode(n){
  const y = n.data('year');
  return (y !== undefined && y !== null && ('' + y).trim() !== '');
}
function hasUnknownParentByRole(n){
  const incomers = n.incomers('edge');
  const mfEdges = incomers.filter(e => {
    const r = e.data('role');
    return r === 'mother' || r === 'father';
  });
  const parents = mfEdges.sources();
  for(const p of parents){
    const pl = ((p.data('label') ?? '') + '').trim().toLowerCase();
    if(pl === 'unknown' || pl === '不明') return true;
  }
  return false;
}

/* Sorting */
const collJa = new Intl.Collator('ja', { numeric: true, sensitivity: 'base' });
const collEn = new Intl.Collator('en', { numeric: true, sensitivity: 'base' });
function labelGroup(label){
  const s = (label ?? '').toString().trim();
  if(!s) return 3;
  const ch = s[0];
  if(/[0-9]/.test(ch)) return 2;
  if(/[A-Za-z]/.test(ch)) return 1;
  if(/[\u3040-\u30FF\u3400-\u9FFF]/.test(ch)) return 0;
  return 3;
}
function compareLabelJPENNUM(a, b){
  const la = (a.data('label') ?? '').toString();
  const lb = (b.data('label') ?? '').toString();
  const ga = labelGroup(la);
  const gb = labelGroup(lb);
  if(ga !== gb) return ga - gb;
  if(ga === 1) return collEn.compare(la, lb);
  return collJa.compare(la, lb);
}
function parseYear(n){
  const y = (n.data('year') ?? '').toString().trim();
  const num = parseInt(y, 10);
  return Number.isFinite(num) ? num : null;
}

/* ===== mobile tabs ===== */
function setTab(name){
  document.body.classList.remove('tab-left','tab-cy','tab-right');
  document.body.classList.add(`tab-${name}`);
  document.querySelectorAll('#mobileTabs button[data-tab]').forEach(b=>{
    b.classList.toggle('active', b.dataset.tab === name);
  });

  if(name === 'cy' && cy){
    // 表示切替直後はサイズが不安定なので2回resize
    requestAnimationFrame(() => {
      cy.resize();
      setTimeout(() => cy.resize(), 80);
    });
  }
}
function initMobileTabs(){
  function onChange(){
    if(isMobileNow()){
      setTab('cy');
      const intro = document.getElementById('introDesktop');
      if(intro) intro.style.display = 'none';
    }else{
      document.body.classList.remove('tab-left','tab-cy','tab-right');
      const intro = document.getElementById('introDesktop');
      if(intro) intro.style.display = '';
    }
  }
  mqMobile.addEventListener('change', onChange);
  onChange();

  document.getElementById('mobileTabs').addEventListener('click', (e)=>{
    const btn = e.target.closest('button[data-tab]');
    if(!btn) return;
    setTab(btn.dataset.tab);
  });
}

/* ===== zoom (viewport center fixed) ===== */
function initZoomButtons(){
  const inBtn = document.getElementById('btnZoomIn');
  const outBtn = document.getElementById('btnZoomOut');
  const fitBtn = document.getElementById('btnFit');
  if(!inBtn || !outBtn || !fitBtn) return;

  const clamp = (v, lo, hi) => Math.max(lo, Math.min(hi, v));

  function zoomAtViewportCenter(nextLevel){
    if(!cy) return;
    const level = clamp(nextLevel, 0.08, 3.5);
    const center = { x: cy.width()/2, y: cy.height()/2 };
    cy.zoom({ level, renderedPosition: center });
  }

  inBtn.addEventListener('click', () => zoomAtViewportCenter(cy.zoom() * 1.2));
  outBtn.addEventListener('click', () => zoomAtViewportCenter(cy.zoom() / 1.2));
  fitBtn.addEventListener('click', () => {
    const pad = isMobileNow() ? 90 : 30;
    cy.fit(undefined, pad);
  });
}

/* ===== pan controls (D-pad) ===== */
function initPanButtons(){
  const need = ['panUp','panDown','panLeft','panRight','panCenter'];
  if(!need.every(id => document.getElementById(id))) return;

  /* ★ 修正①：十字ボタンを「ゆっくり」動かす（初動も連続も遅く） */
  const stepPx = () => (isMobileNow() ? 30 : 20);   // 60/40 → 42/28
  const intervalMs = 50;                            // 60 → 90（更新頻度を下げてゆっくり）
  const holdScale = 0.10;                           // 0.55 → 0.40（1回あたりの移動量を減らす）

  function panBy(dx, dy){
    if(!cy) return;
    const p = cy.pan();
    cy.pan({ x: p.x + dx, y: p.y + dy });
  }

  function bindHold(btnId, dx, dy){
    const el = document.getElementById(btnId);
    let timer = null;

    el.addEventListener('contextmenu', (e)=> e.preventDefault());
    el.addEventListener('selectstart', (e)=> e.preventDefault());

    const start = (e)=>{
      e.preventDefault();
      const s = stepPx();
      // 初動（1回目）も少し控えめに
      panBy(dx * s * 0.75, dy * s * 0.75);
      timer = setInterval(()=> panBy(dx * s * holdScale, dy * s * holdScale), intervalMs);
    };
    const stop = ()=>{
      if(timer){ clearInterval(timer); timer = null; }
    };

    el.addEventListener('pointerdown', start);
    el.addEventListener('pointerup', stop);
    el.addEventListener('pointercancel', stop);
    el.addEventListener('pointerleave', stop);
  }

  // NOTE: cy.pan() は「グラフ座標系の移動」なので、
  //      画面上で“上へ見える”方向は y を増やすのが自然です。
  bindHold('panUp',    0,  1);
  bindHold('panDown',  0, -1);
  bindHold('panLeft',  1,  0);
  bindHold('panRight', -1, 0);

  document.getElementById('panCenter').addEventListener('click', ()=>{
    if(!cy) return;
    cy.center();
  });
}

/* ===== detail ===== */
function setDetail(n){
  if(!n){
    document.getElementById('detail').innerHTML =
      '<span class="muted">品種名をクリックすると詳細が表示されます。</span>';
    return;
  }

  const d = n.data();
  const year = d.year ? `<div><b>品種登録年</b>：${esc(d.year)}</div>` : '';
  const inst = d.institute ? `<div><b>品種登録者</b>：${esc(d.institute)}</div>` : '';
  const notes = d.notes ? `<div style="margin-top:8px;"><b>メモ</b><div>${esc(d.notes)}</div></div>` : '';

  let sourcesHtml = '';
  if(d.sources){
    const parts = d.sources.toString().split(/[\n;]+/).map(x => x.trim()).filter(Boolean);
    const links = parts.map(p => {
      const isUrl = /^https?:\/\//i.test(p);
      return isUrl
        ? `<div><a href="${esc(p)}" target="_blank" rel="noopener noreferrer">${esc(p)}</a></div>`
        : `<div>${esc(p)}</div>`;
    }).join('');
    sourcesHtml = `<div style="margin-top:8px;"><b>品種登録情報</b>${links}</div>`;
  }

  const incomers = n.incomers('edge');
  const mothers = incomers.filter(e => e.data('role') === 'mother').sources().map(x => x.data('label'));
  const fathers = incomers.filter(e => e.data('role') === 'father').sources().map(x => x.data('label'));
  const unknowns = incomers.filter(e => e.data('role') === 'unknown').sources().map(x => x.data('label'));

  const outgoers = n.outgoers('edge');
  const children = outgoers.targets().map(x => x.data('label'));

  const motherHtml = mothers.length ? `<div><b>母</b>：${uniq(mothers).map(esc).join(', ')}</div>` : '';
  const fatherHtml = fathers.length ? `<div><b>父</b>：${uniq(fathers).map(esc).join(', ')}</div>` : '';
  const unknownHtml = unknowns.length ? `<div><b>不明親</b>：${uniq(unknowns).map(esc).join(', ')}</div>` : '';
  const childHtml = children.length ? `<div style="margin-top:8px;"><b>子</b><div>${uniq(children).map(esc).join(', ')}</div></div>` : '';

  const crossSources = uniq(incomers.map(e => e.data('source_id')));
  const crossSourcesHtml = crossSources.length
    ? `<div style="margin-top:8px;"><b>交配出典</b><div>${crossSources.map(esc).join('<br>')}</div></div>`
    : '';

  const ph = (d.placeholder === true) ? `<div class="muted" style="margin-top:6px;">※この品種情報は未登録です。</div>` : '';

  document.getElementById('detail').innerHTML = `
    <div class="box">
      <div class="h" style="margin:0 0 6px;">${esc(d.label)}</div>
      ${year}
      ${inst}
      ${motherHtml}
      ${fatherHtml}
      ${unknownHtml}
      ${childHtml}
      ${notes}
      ${crossSourcesHtml}
      ${sourcesHtml}
      ${ph}
    </div>
  `;
}

/* ===== selection ===== */
/* ★ 追加：特定ノードを「画面中央へ」寄せる（検索タブ→グラフで中央に来る用） */
function centerOnNode(n, duration=360){
  if(!cy || !n || !n.length) return;
  cy.animate(
    { center: { eles: n } },
    { duration }
  );
}

function selectNode(n, doFit=true){
  if(!n || !cy) return;

  setDetail(n);

  // いったん全解除
  cy.elements().removeClass('faded');
  cy.elements().removeClass('highlight');

  // 親子を含む近傍（1ホップ）＝ 親・本人・子
  const neighborhood = n.closedNeighborhood();

  // 近傍をハイライト、その他を薄く
  neighborhood.addClass('highlight');
  cy.elements().not(neighborhood).addClass('faded');

  hasHighlight = true;
  updateClearButtons();

  if(doFit){
    cy.animate(
      { fit: { eles: neighborhood, padding: isMobileNow() ? 90 : 80 } },
      { duration: 250 }
    );
  }
}

/* ★ 追加：検索リストから選んだとき専用
   - グラフタブへ切替
   - 選択ノードを画面中央へ
   - その後にハイライト（fitではなく“中央寄せ”を優先） */
function focusFromList(n){
  if(!cy || !n || !n.length) return;

  if(isMobileNow()){
    setTab('cy');

    // ★ 重要：タブ切替でcyが表示・サイズ確定してから中央寄せする
    requestAnimationFrame(() => {
      cy.resize();
      setTimeout(() => {
        cy.resize();         // 念のため2回目
        centerOnNode(n, 420);
        setTimeout(() => selectNode(n, false), 220);
      }, 120);
    });
    return;
  }

  // PCは今まで通りでOK
  centerOnNode(n, 380);
  setTimeout(()=> selectNode(n, false), 220);
}


/* ===== list ===== */
function applyListFilter(nodes){
  if(listFilter === 'reg') return nodes.filter(n => isRegisteredNode(n) && n.data('placeholder') !== true);
  if(listFilter === 'orphan') return nodes.filter(n => hasUnknownParentByRole(n));
  return nodes;
}
function filterLabel(){
  if(listFilter === 'reg') return '登録品種';
  if(listFilter === 'orphan') return '親が不明';
  return '全品種';
}
function renderCultivarList(nodes, badgeText){
  const wrap = document.getElementById('listWrap');
  const badge = document.getElementById('listBadge');
  badge.textContent = badgeText;

  if(!nodes.length){
    wrap.innerHTML = `<div class="emptyRow">該当する品種がありません。</div>`;
    return;
  }

  const rows = nodes.map(n => {
    const d = n.data();
    const label = esc(d.label ?? '');
    const year = esc(d.year ?? '');
    const inst = esc(d.institute ?? '');
    const id = esc(d.id ?? n.id());
    return `
      <tr data-node-id="${id}">
        <td>${label || '<span class="td-muted">（無名）</span>'}</td>
        <td class="td-muted" style="white-space:nowrap;">${year || '-'}</td>
        <td class="td-muted">${inst || '-'}</td>
      </tr>
    `;
  }).join('');

  wrap.innerHTML = `
    <table>
      <thead>
        <tr>
          <th style="width:35%;">品種</th>
          <th style="width:18%;">登録年</th>
          <th>登録者</th>
        </tr>
      </thead>
      <tbody>${rows}</tbody>
    </table>
  `;

  wrap.querySelectorAll('tbody tr').forEach(tr => {
    tr.addEventListener('click', () => {
      const nodeId = tr.getAttribute('data-node-id');
      const n = cy.getElementById(nodeId);
      if(n && n.length){
        /* ★ 修正②：検索タブでタップ→グラフ中央へ */
        focusFromList(n);
      }
    });
  });
}

function updateListAndHighlights(){
  if(!cy) return;

  const term = (document.getElementById('q').value ?? '').trim().toLowerCase();

  let base = cy.nodes().filter(n => !isUnknownNode(n));
  let nodes = applyListFilter(base);

  if(term){
    nodes = nodes.filter(n => {
      const label = ((n.data('label') || '') + '').toLowerCase();
      const inst  = ((n.data('institute') || '') + '').toLowerCase();
      return label.includes(term) || inst.includes(term);
    });
  }

  const sorted = nodes.toArray().sort((a, b) => {
    if(listFilter === 'reg'){
      const ya = parseYear(a);
      const yb = parseYear(b);
      const va = (ya !== null);
      const vb = (yb !== null);

      if(va && vb && ya !== yb) return yb - ya;
      if(va !== vb) return va ? -1 : 1;
      return compareLabelJPENNUM(a, b);
    }
    return compareLabelJPENNUM(a, b);
  });

  const badgeText = term
    ? `検索結果（${filterLabel()}）：${sorted.length}件`
    : `${filterLabel()}：${sorted.length}件`;

  renderCultivarList(sorted, badgeText);
}

function runLayout(mode){
  if(!cy) return;
  cy.stop();

  const isM = isMobileNow();

  showCyLoading(mode === 'dagre'
    ? '数十秒かかることがあります'
    : '数十秒かかることがあります'
  );

  // フェイルセーフ：layoutstopが来ない場合に解除
  const failSafeTimer = setTimeout(() => {
    hideCyLoading();
    console.warn('layoutstopが来ないためフェイルセーフで解除');
  }, 30000);

  let opts;
  if(mode === 'dagre'){
    opts = {
      name: 'dagre',
      rankDir: 'LR',
      nodeSep: isM ? 40 : 20,
      edgeSep: isM ? 10 : 5,
      rankSep: isM ? 140 : 90,
      padding: 30,
      nodeDimensionsIncludeLabels: true,
      animate: false
    };
  }else{
    opts = {
      name: 'cose',
      padding: 30,
      animate: false,
      randomize: false,
      avoidOverlap: true,
      avoidOverlapPadding: isM ? 40 : 20,
      nodeOverlap: 40,
      nodeRepulsion: isM ? 12000 : 6500,
      idealEdgeLength: isM ? 220 : 140,
      componentSpacing: isM ? 120 : 80,
      numIter: 1200
    };
  }

  // ★ここがポイント：まず描画を通してからlayout.run()
  requestAnimationFrame(() => {
    setTimeout(() => {
      const layout = cy.layout(opts);

layout.on('layoutstop', () => {
  clearTimeout(failSafeTimer);
  hideCyLoading();

  // ★まず軽く fit（最低限の安定）
  cy.fit(undefined, isM ? 20 : 6);

  // ★候補ノードへフォーカス（見つからなければそのまま）
  const ok = focusInitialNode();
  if(!ok){
    // フォールバック：候補が見つからない場合は普通のfit
    cy.fit(undefined, isM ? 30 : 10);
  }
});



      layout.run();
    }, 0);
  });
}



function setActiveLayout(btnId){
  document.getElementById('btnCose').classList.toggle('active', btnId === 'btnCose');
  document.getElementById('btnDagre').classList.toggle('active', btnId === 'btnDagre');
}

function setActiveFilter(btnId){
  ['f_all','f_reg','f_orphan'].forEach(id => {
    const el = document.getElementById(id);
    el.classList.toggle('active', id === btnId);
  });
}

/* ===== init cy ===== */
function initCy(elements){
  showCyLoading('系統図を配置しています。しばらくお待ちください。');
  cy = cytoscape({
    container: document.getElementById('cy'),
    elements,
    style: [
      {
        selector: 'node',
        style: {
          'label': 'data(label)',
          'font-size': nodeFontSize(),
          'text-wrap': 'wrap',
          'text-max-width': textMaxWidth(),
          'text-valign': 'center',
          'text-halign': 'center',
          'background-color': '#FCE7F3',
          'border-width': 1.8,
          'border-color': '#F9A8D4',
          'color': '#831843',
          'width': 'label',
          'padding': isMobileNow() ? '16px' : '12px',
          'shape': 'round-rectangle'
        }
      },
      {
        selector: 'node.registered',
        style: {
          'border-width': 2.8,
          'border-color': '#ff5fa2',
          'background-color': '#ffd9eb',
          'font-weight': '700',
          'shadow-blur': 10,
          'shadow-color': '#ff9ac6',
          'shadow-opacity': 0.35
        }
      },
      {
        selector: 'node.isPlaceholder',
        style: {
          'background-color': '#FFF5FB',
          'border-color': '#FBCFE8',
          'color': '#9F1239',
          'shadow-opacity': 0
        }
      },
      {
        selector: 'edge',
        style: {
          'target-arrow-shape': 'triangle',
          'target-arrow-fill': 'filled',
          'arrow-scale': isMobileNow() ? 1.4 : 1.2,
          'width': isMobileNow() ? 2.4 : 2,
          'line-color': '#F472B6',
          'target-arrow-color': '#F472B6',
          'curve-style': 'unbundled-bezier',
          'edge-distances': 'node-position'
        }
      },
      { selector: 'edge[role="mother"]', style: { 'line-style': 'solid',  'control-point-distance': isMobileNow() ? 40 : 30, 'control-point-weight': 0.5 } },
      { selector: 'edge[role="father"]', style: { 'line-style': 'dashed', 'control-point-distance': isMobileNow() ? -40 : -30,'control-point-weight': 0.5 } },
      { selector: 'edge[role="unknown"]', style: { 'line-style': 'dotted','line-color': '#E5E7EB','target-arrow-color': '#E5E7EB','control-point-distance': 18,'control-point-weight': 0.5 } },
      { selector: '.faded', style: { 'opacity': 0.2 } },
      { selector: '.highlight', style: { 'border-width': 3, 'border-color': '#FB7185' } }
    ],
layout: { name: 'preset' } 
  });

  // classes from data
  cy.batch(() => {
    cy.nodes().forEach(n => {
      const d = n.data();
      if (d.year !== undefined && d.year !== null && d.year !== '') n.addClass('registered');
      if (d.placeholder === true) n.addClass('isPlaceholder');
    });
  });

  // classes from data
  cy.batch(() => {
    cy.nodes().forEach(n => {
      const d = n.data();
      if (d.year !== undefined && d.year !== null && d.year !== '') n.addClass('registered');
      if (d.placeholder === true) n.addClass('isPlaceholder');
    });
  });

  // ★追加：子の数(childCount)を計算して data に入れる
  let maxChildCount = 0;

  cy.batch(() => {
    cy.nodes().forEach(n => {
      // 「親(このノード) → 子」なので outgoers が子
      // 同じ子が重複しないように id でユニーク化
      const children = n.outgoers('edge').targets().filter(t => !isUnknownNode(t));
      const uniqIds = new Set(children.map(t => t.id()));
      const cnt = uniqIds.size;

      n.data('childCount', cnt);
      if (cnt > maxChildCount) maxChildCount = cnt;
    });
  });

  // ★追加：childCount に応じてサイズ/文字サイズを反映
  applyNodeScaleStyle(maxChildCount);



  /* グラフ内タップ：ハイライト（fitはしない） */
  cy.on('tap', 'node', (evt) => selectNode(evt.target, false));

  /* 背景タップ：解除 */
  cy.on('tap', (evt) => {
    if(evt.target === cy){
      clearHighlight();
    }
  });

  document.getElementById('q').addEventListener('input', updateListAndHighlights);

  document.getElementById('f_all').addEventListener('click', () => { listFilter='all'; setActiveFilter('f_all'); updateListAndHighlights(); });
  document.getElementById('f_reg').addEventListener('click', () => { listFilter='reg'; setActiveFilter('f_reg'); updateListAndHighlights(); });
  document.getElementById('f_orphan').addEventListener('click', () => { listFilter='orphan'; setActiveFilter('f_orphan'); updateListAndHighlights(); });

  document.getElementById('btnCose').addEventListener('click', () => { setActiveLayout('btnCose'); runLayout('cose'); });
  document.getElementById('btnDagre').addEventListener('click', () => { setActiveLayout('btnDagre'); runLayout('dagre'); });

  /* ★ 修正③：ハイライト解除ボタン */
  const btnClearHL = document.getElementById('btnClearHL');
  if(btnClearHL){
    btnClearHL.addEventListener('click', (e)=>{ e.preventDefault(); clearHighlight(); });
  }
  const btnClearHLDesk = document.getElementById('btnClearHLDesk');
  if(btnClearHLDesk){
    btnClearHLDesk.addEventListener('click', ()=> clearHighlight());
  }
  updateClearButtons();

  updateListAndHighlights();

setActiveLayout('btnCose');
requestAnimationFrame(() => runLayout('cose'));



setTimeout(()=>{ 
  cy.resize();

}, 50);


  mqMobile.addEventListener('change', () => {
  if(!cy) return;

  // childCount の最大値を取り直す（dataにあるので高速）
  let maxC = 0;
  cy.nodes().forEach(n => {
    const c = Number(n.data('childCount') ?? 0);
    if(c > maxC) maxC = c;
  });

  cy.style()
    .selector('node')
    .style('text-max-width', textMaxWidth())
    .update();

  applyNodeScaleStyle(maxC);

  cy.resize();
});

}

function initialZoomIn(boostMobile = 4, boostDesk = 4){
if(!cy) return;

  // いったん軽く fit（余白は小さめ）
  const pad = isMobileNow() ? 20 : 6;
  cy.fit(undefined, pad);

  // fit後に「画面中心を基準に」ズームを上乗せ
  const boost = isMobileNow() ? boostMobile : boostDesk;
  const center = { x: cy.width()/2, y: cy.height()/2 };
  cy.zoom({ level: cy.zoom() * boost, renderedPosition: center });
}

  
  function applyNodeScaleStyle(maxChildCount){
  if(!cy) return;

  // 子が全員0のケースでも mapData が壊れないように
  const maxC = Math.max(1, maxChildCount);

  // 「子=0 のとき現状維持」を守る
  const minPad  = isMobileNow() ? 8 : 6;  // ←今の値
  const maxPad  = isMobileNow() ? 24 : 18;  // ←増えた時どこまで大きくしたいか（好みで調整）

  const minFont = nodeFontSize();           // ←今の値 (mobile 18 / desktop 12)
  const maxFont = isMobileNow() ? 50 : 40;  // ←増えた時の上限（好みで調整）

  cy.style()
    .selector('node')
    // ノードの“最小サイズ”は今まで通り label + padding 依存のまま、
    // padding を増やして「大きく」する
    .style('padding', `mapData(childCount, 0, ${maxC}, ${minPad}, ${maxPad})`)
    // 文字サイズも連動
    .style('font-size', `mapData(childCount, 0, ${maxC}, ${minFont}, ${maxFont})`)
    .update();
}

  
/* ===== load ===== */
async function loadElements(){
  const wrap = document.getElementById('listWrap');
  const badge = document.getElementById('listBadge');

  try{
    initMobileTabs();
    initZoomButtons();
    initPanButtons();

    const url = "elements.json?ts=" + Date.now();
    const res = await fetch(url, { cache: "no-store" });
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const elements = await res.json();

    initCy(elements);
  }catch(err){
    badge.textContent = '読み込み失敗';
    wrap.innerHTML = `<div class="emptyRow">読み込み失敗：${esc(err.message)}<br>（elements.json が root にあるか確認）</div>`;
    hideCyLoading();
  }
}
loadElements();
</script>
</body>
</html>
