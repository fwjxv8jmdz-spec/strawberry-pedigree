<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Strawberry Pedigree</title>

  <!-- Cytoscape core -->
  <script src="https://unpkg.com/cytoscape@3.27.0/dist/cytoscape.min.js"></script>

  <!-- dagre -->
  <script src="https://unpkg.com/dagre@0.8.5/dist/dagre.min.js"></script>
  <script src="https://unpkg.com/cytoscape-dagre@2.5.0/cytoscape-dagre.js"></script>

  <!-- fCoSE / cose-bilkent / spread -->
<!-- local plugins -->
<script src="./vendor/cytoscape-fcose.js"></script>
<script src="./vendor/cytoscape-cose-bilkent.js"></script>
<script src="./vendor/cytoscape-spread.js"></script>

<script>
  // プラグイン登録（ローカルならこれで確実に通る）
  cytoscape.use(cytoscapeFcose);
  cytoscape.use(cytoscapeCoseBilkent);
  cytoscape.use(cytoscapeSpread);
</script>


  <script>
    // ---- Robust plugin registration (works across UMD/default exports) ----
    function usePlugin(nameCandidates){
      for(const key of nameCandidates){
        const v = window[key];
        if(!v) continue;

        // some bundles export { default: fn }
        const fn = (typeof v === 'function') ? v
                 : (v && typeof v.default === 'function') ? v.default
                 : null;

        if(fn){
          try { cytoscape.use(fn); }
          catch(e){ /* ignore double-register */ }
          return true;
        }
      }
      return false;
    }

    // register plugins
    window.__hasFcose = usePlugin(['cytoscapeFcose']);
    window.__hasCoseBilkent = usePlugin(['cytoscapeCoseBilkent']);
    window.__hasSpread = usePlugin(['cytoscapeSpread']);
  </script>

  <style>
    body { margin: 0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif; }
    #app { display: grid; grid-template-columns: 320px 1fr 360px; height: 100vh; }
    #left, #right { padding: 12px; border-right: 1px solid #e5e7eb; overflow: auto; }
    #right { border-right: none; border-left: 1px solid #e5e7eb; }
    #cy { width: 100%; height: 100%; }

    .h { font-weight: 700; margin: 6px 0 10px; }
    .muted { color: #6b7280; font-size: 12px; line-height: 1.4; }
    .box { border: 1px solid #e5e7eb; border-radius: 10px; padding: 10px; margin: 10px 0; }

    input[type="text"], select {
      width: 100%;
      box-sizing: border-box;
      padding: 10px;
      border: 1px solid #d1d5db;
      border-radius: 10px;
      background: #fff;
    }

    button {
      padding: 8px 10px;
      border: 1px solid #d1d5db;
      background: #fff;
      border-radius: 10px;
      cursor: pointer;
    }
    button:hover { background: #f9fafb; }

    .row { display: flex; gap: 8px; }
    .row > * { flex: 1; }

    .tag {
      display:inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      font-size: 12px;
      margin-right: 6px;
      background: #fff;
    }

    a { color: #2563eb; text-decoration: none; }
    a:hover { text-decoration: underline; }
  </style>
</head>

<body>
<div id="app">
  <div id="left">
    <div class="h">検索</div>
    <input id="q" type="text" placeholder="品種名 / 品種登録者で検索（例：とちおとめ、栃木県）" />

    <div class="row" style="margin-top:10px;">
      <button id="fit">全体表示</button>
      <button id="clear">選択解除</button>
    </div>

    <div class="box">
      <div class="h" style="margin:0 0 6px;">レイアウト</div>

      <div class="row">
        <select id="layoutMode">
          <option value="cose" selected>COSE（力学・初期）</option>
          <option value="fcose">fCoSE（大規模向け）</option>
          <option value="coseBilkent">COSE-Bilkent（安定・見やすい）</option>
          <option value="dagreLR">Dagre 横（左→右）</option>
          <option value="spread">Spread（ばらけ探索）</option>
        </select>
        <button id="applyLayout">適用</button>
      </div>

      <div style="margin-top:8px;">
        <button id="layout_reset" style="width:100%;">配置リセット（COSE）</button>
      </div>

      <div class="muted" style="margin-top:6px;">
        ※ fCoSE / COSE-Bilkent / Spread が動かない場合は、プラグイン読み込み失敗の可能性があります。
      </div>
    </div>

    <div class="box">
      <div class="h" style="margin:0 0 6px;">凡例</div>
      <div><span class="tag">母 → 子</span> 実線</div>
      <div><span class="tag">父 → 子</span> 破線</div>
      <div><span class="tag">不明 → 子</span> 点線</div>
      <div class="muted" style="margin-top:6px;">ノードをドラッグして配置変更・ホイールで拡大縮小できます。</div>
    </div>

    <div class="box">
      <div class="h" style="margin:0 0 6px;">読み込み</div>
      <div id="status" class="muted">elements.json を読み込み中…</div>
      <div class="muted" style="margin-top:6px;">更新が反映されない時は Ctrl+F5（強制再読み込み）も試してください。</div>
    </div>
  </div>

  <div id="cy"></div>

  <div id="right">
    <div class="h">詳細</div>
    <div id="detail" class="muted">ノードをクリックすると情報が表示されます。</div>
  </div>
</div>

<script>
let cy = null;

function esc(s){
  return (s ?? '').toString()
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;');
}

function uniq(arr){
  const seen = new Set();
  const out = [];
  for(const v of arr){
    const s = (v ?? '').toString().trim();
    if(!s) continue;
    if(seen.has(s)) continue;
    seen.add(s);
    out.push(s);
  }
  return out;
}

function setDetail(n){
  if(!n){
    document.getElementById('detail').innerHTML =
      '<span class="muted">ノードをクリックすると情報が表示されます。</span>';
    return;
  }

  const d = n.data();
  const year = d.year ? `<div><b>品種登録年</b>：${esc(d.year)}</div>` : '';
  const inst = d.institute ? `<div><b>品種登録者</b>：${esc(d.institute)}</div>` : '';
  const notes = d.notes ? `<div style="margin-top:8px;"><b>メモ</b><div>${esc(d.notes)}</div></div>` : '';

  let sourcesHtml = '';
  if(d.sources){
    const parts = d.sources.toString().split(/[\n;]+/).map(x => x.trim()).filter(Boolean);
    const links = parts.map(p => {
      const isUrl = /^https?:\/\//i.test(p);
      return isUrl
        ? `<div><a href="${esc(p)}" target="_blank" rel="noopener noreferrer">${esc(p)}</a></div>`
        : `<div>${esc(p)}</div>`;
    }).join('');
    sourcesHtml = `<div style="margin-top:8px;"><b>品種登録情報</b>${links}</div>`;
  }

  const incomers = n.incomers('edge');
  const mothers = incomers.filter(e => e.data('role') === 'mother').sources().map(x => x.data('label'));
  const fathers = incomers.filter(e => e.data('role') === 'father').sources().map(x => x.data('label'));
  const unknowns = incomers.filter(e => e.data('role') === 'unknown').sources().map(x => x.data('label'));

  const outgoers = n.outgoers('edge');
  const children = outgoers.targets().map(x => x.data('label'));

  const motherHtml = mothers.length ? `<div><b>母</b>：${uniq(mothers).map(esc).join(', ')}</div>` : '';
  const fatherHtml = fathers.length ? `<div><b>父</b>：${uniq(fathers).map(esc).join(', ')}</div>` : '';
  const unknownHtml = unknowns.length ? `<div><b>不明親</b>：${uniq(unknowns).map(esc).join(', ')}</div>` : '';
  const childHtml = children.length ? `<div style="margin-top:8px;"><b>子</b><div>${uniq(children).map(esc).join(', ')}</div></div>` : '';

  const crossSources = uniq(incomers.map(e => e.data('source_id')));
  const crossSourcesHtml = crossSources.length
    ? `<div style="margin-top:8px;"><b>交配出典</b><div>${crossSources.map(esc).join('<br>')}</div></div>`
    : '';

  const ph = (d.placeholder === true) ? `<div class="muted" style="margin-top:6px;">※この品種情報は未登録です。</div>` : '';

  document.getElementById('detail').innerHTML = `
    <div class="box">
      <div class="h" style="margin:0 0 6px;">${esc(d.label)}</div>
      ${year}
      ${inst}
      ${motherHtml}
      ${fatherHtml}
      ${unknownHtml}
      ${childHtml}
      ${notes}
      ${crossSourcesHtml}
      ${sourcesHtml}
      ${ph}
    </div>
  `;
}

function ensurePlugin(mode){
  if(mode === 'fcose' && !window.__hasFcose){
    alert('fCoSE プラグインが読み込めていません（script URL / ネットワーク / CSP を確認）');
    return false;
  }
  if(mode === 'coseBilkent' && !window.__hasCoseBilkent){
    alert('COSE-Bilkent プラグインが読み込めていません（script URL / ネットワーク / CSP を確認）');
    return false;
  }
  if(mode === 'spread' && !window.__hasSpread){
    alert('Spread プラグインが読み込めていません（script URL / ネットワーク / CSP を確認）');
    return false;
  }
  return true;
}

function runLayout(mode){
  if(!cy) return;
  if(!ensurePlugin(mode)) return;

  cy.stop();

  const common = { animate: true, padding: 30 };

  let opts;
  switch(mode){
    case 'fcose':
      opts = {
        name: 'fcose',
        ...common,
        quality: 'default',
        randomize: true,
        nodeRepulsion: 9000,
        idealEdgeLength: 140,
        edgeElasticity: 0.45,
        gravity: 0.35,
        numIter: 2500
      };
      break;

    case 'coseBilkent':
      opts = {
        name: 'cose-bilkent',
        ...common,
        randomize: true,
        nodeRepulsion: 9000,
        idealEdgeLength: 140,
        edgeElasticity: 0.45,
        gravity: 0.25,
        numIter: 2500
      };
      break;

    case 'dagreLR':
      opts = {
        name: 'dagre',
        ...common,
        rankDir: 'LR',
        nodeSep: 20,
        edgeSep: 5,
        rankSep: 90,
        nodeDimensionsIncludeLabels: true
      };
      break;

    case 'spread':
      opts = {
        name: 'spread',
        ...common,
        minDist: 50,
        expandFactor: 1.2,
        randomize: true
      };
      break;

    case 'cose':
    default:
      opts = {
        name: 'cose',
        ...common,
        randomize: true,
        nodeRepulsion: 4500,
        idealEdgeLength: 120
      };
  }

  cy.layout(opts).run();
  cy.fit(undefined, 30);
}

function initCy(elements){
  cy = cytoscape({
    container: document.getElementById('cy'),
    elements,
    style: [
      {
        selector: 'node',
        style: {
          'label': 'data(label)',
          'font-size': 12,
          'text-wrap': 'wrap',
          'text-max-width': 150,
          'text-valign': 'center',
          'text-halign': 'center',
          'background-color': '#FCE7F3',
          'border-width': 1.5,
          'border-color': '#F9A8D4',
          'color': '#831843',
          'width': 'label',
          'padding': '12px',
          'shape': 'round-rectangle'
        }
      },
      {
        selector: 'node.registered',
        style: {
          'border-width': 2.6,
          'border-color': '#ff5fa2',
          'background-color': '#ffd9eb',
          'font-weight': '600',
          'shadow-blur': 10,
          'shadow-color': '#ff9ac6',
          'shadow-opacity': 0.35
        }
      },
      {
        selector: 'node.isPlaceholder',
        style: {
          'background-color': '#FFF5FB',
          'border-color': '#FBCFE8',
          'color': '#9F1239',
          'shadow-opacity': 0
        }
      },

      {
        selector: 'edge',
        style: {
          'curve-style': 'unbundled-bezier',
          'edge-distances': 'node-position',
          'target-arrow-shape': 'triangle',
          'arrow-scale': 0.9,
          'width': 2,
          'line-color': '#F472B6',
          'target-arrow-color': '#F472B6'
        }
      },
      {
        selector: 'edge[role="mother"]',
        style: {
          'line-style': 'solid',
          'line-color': '#F472B6',
          'target-arrow-color': '#F472B6',
          'control-point-distance': 30,
          'control-point-weight': 0.5
        }
      },
      {
        selector: 'edge[role="father"]',
        style: {
          'line-style': 'dashed',
          'line-color': '#F472B6',
          'target-arrow-color': '#F472B6',
          'control-point-distance': -30,
          'control-point-weight': 0.5
        }
      },
      {
        selector: 'edge[role="unknown"]',
        style: {
          'line-style': 'dotted',
          'line-color': '#E5E7EB',
          'target-arrow-color': '#E5E7EB',
          'control-point-distance': 18,
          'control-point-weight': 0.5
        }
      },

      { selector: '.faded', style: { 'opacity': 0.2 } },
      { selector: '.highlight', style: { 'border-width': 3, 'border-color': '#FB7185' } }
    ],

    // 初期は COSE
    layout: {
      name: 'cose',
      padding: 30,
      animate: true,
      randomize: true,
      nodeRepulsion: 4500,
      idealEdgeLength: 120
    }
  });

  // クラス付与
  cy.batch(() => {
    cy.nodes().forEach(n => {
      const d = n.data();
      if (d.year !== undefined && d.year !== null && d.year !== '') n.addClass('registered');
      if (d.placeholder === true) n.addClass('isPlaceholder');
    });
  });

  // click handlers
  cy.on('tap', 'node', (evt) => {
    const n = evt.target;
    setDetail(n);

    cy.elements().removeClass('faded');
    cy.elements().removeClass('highlight');

    const neighborhood = n.closedNeighborhood();
    cy.elements().not(neighborhood).addClass('faded');
    n.addClass('highlight');
  });

  cy.on('tap', (evt) => {
    if(evt.target === cy){
      cy.elements().removeClass('faded');
      cy.elements().removeClass('highlight');
      setDetail(null);
    }
  });

  // search
  const q = document.getElementById('q');
  q.addEventListener('input', () => {
    const term = q.value.trim().toLowerCase();
    cy.nodes().removeClass('highlight');
    if(!term) return;

    const matched = cy.nodes().filter(n => {
      const label = ((n.data('label') || '') + '').toLowerCase();
      const inst  = ((n.data('institute') || '') + '').toLowerCase();
      return label.includes(term) || inst.includes(term);
    });

    matched.addClass('highlight');
    if(matched.length){
      cy.animate({ fit: { eles: matched, padding: 80 } }, { duration: 200 });
    }
  });

  // buttons
  document.getElementById('fit').addEventListener('click', () => cy.fit(undefined, 30));
  document.getElementById('clear').addEventListener('click', () => {
    q.value = '';
    cy.elements().removeClass('faded');
    cy.elements().removeClass('highlight');
    setDetail(null);
  });

  document.getElementById('applyLayout').addEventListener('click', () => {
    const mode = document.getElementById('layoutMode').value;
    runLayout(mode);
  });

  document.getElementById('layout_reset').addEventListener('click', () => {
    document.getElementById('layoutMode').value = 'cose';
    runLayout('cose');
  });

  cy.fit(undefined, 30);
}

async function loadElements(){
  const status = document.getElementById('status');
  try{
    const url = "elements.json?ts=" + Date.now();
    const res = await fetch(url, { cache: "no-store" });
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const elements = await res.json();

    status.textContent = `読み込み完了：nodes+edges=${elements.length}`;
    initCy(elements);
  }catch(err){
    status.innerHTML = `読み込み失敗：${esc(err.message)}<br>（elements.json がリポジトリの root にあるか確認してください）`;
  }
}

loadElements();
</script>
</body>
</html>
